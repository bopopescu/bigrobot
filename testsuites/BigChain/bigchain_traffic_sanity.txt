*Settings
Documentation  BigChain Sanity
Suite Setup  bigchain suite setup
#Suite Teardown   base suite teardown
Test Setup   traffic test setup
Test Teardown   traffic test teardown
Force Tags   BigChain  Sanity

Library  keywords/BsnCommon.py
Library  keywords/AppController.py
Library  keywords/BigChain.py
Library  keywords/SwitchLight.py
Library  keywords/Ixia.py

* Variable
${version_string}  Big Network Controller 3.0.0
${switch_name_1}   APP-RLB9-1
${chain_name_1}    chain1
${chain_1_interface_1}  ethernet1  
${chain_1_interface_2}  ethernet2
${chain_1_service_pre_interface_1}  ethernet47  
${chain_1_service_post_interface_2}  ethernet48

    
* Test Case
Configure and Verify Configuration  
    rest verify bigchain chain  s1  ${chain_name_1}  ${chain_1_interface_1}  ${chain_1_interface_2}      
    [Tags]  verify 

Verify L2 traffic is received corretcly
    ${stream}=  L2 add  flow=a->b  line_rate=100  frame_size=64  name=a_b_flow
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_valid_frame_rate    
    stop traffic  ${stream}
    [Tags]  l2  traffic  

Verify L3 traffic is received corretcly
    ${stream}=  L3 add  flow=a->b  line_rate=100  frame_size=1280  
    ...     src_mac=00:02:03:04:05:06  dst_mac=00:02:03:04:05:07  no_arp=True
    ...     src_ip=100.1.1.1  dst_ip=100.1.1.2  name=a_b_flow
    clear stats  
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_valid_frame_rate        
    stop traffic  ${stream}
    [Tags]  l3  traffic  


* Keywords

bigchain suite setup
    base suite setup
    rest add switch alias  s1  ${switch_name_1}    
    rest add a chain  ${chain_name_1}
    rest add endpoint  s1  ${chain_name_1}  ${chain_1_interface_1}  ${chain_1_interface_2}

traffic test setup
    ixia initialize  tg1  init=true
        
verify results   [Arguments]  ${send_port}  ${recv_port}  ${transmitted_frames}  ${received_valid_frames}
    Sleep  5
    ${report}=  fetch port stats
    ${tx_value}=  verify dict key  ${report}  ${send_port}  ${transmitted_frames}
    ${rx_value}=  verify dict key  ${report}  ${recv_port}  ${received_valid_frames}
    ${in_range}=  ixia verify traffic rate  ${tx_value}  ${rx_value}
    Should be true  ${in_range}
    
traffic test teardown
    delete traffic
    sleep  2     