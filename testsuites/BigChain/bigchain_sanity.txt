*Settings
Documentation           BigChain Sanity Test Suite
Suite Setup             sanity suite setup
Suite Teardown          sanity suite teardown
Test Setup              sanity test setup
Test Teardown           sanity test teardown
Force Tags              bigchain  corsair-plus  4.5.0  accton  AS5710
Library                 keywords/BsnCommon.py
Library                 keywords/AppController.py
Library                 keywords/BigTap.py
Library                 keywords/BigChain.py
Library                 keywords/SwitchLight.py
Library                 keywords/Ixia.py
Library                 Collections.py
Library                 OperatingSystem.py
Library                 String.py

* Variable
${switch1_alias}        app-ras5710-trident-1
${switch2_alias}        app-ras5710-nontrident-1
${chain_name}           CHAIN1
${chain_interface_1}    ethernet1
${chain_interface_2}    ethernet2

* Test Case

TC001: Verify switch mode in output of "show switch" is bigtap by default
    ${result}=  rest verify switch mode show  node=s1  mode=bigtap-full-match
    Should be true  ${result}
    [Tags]  sanity  feature

TC002: Verify switch mode can be changed to big chain mode and changed mode is visible in show output
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest verify switch mode show  node=s1  mode=bigchain
    Should be true  ${result2}
    [Tags]  sanity  feature

TC003: Verify switch mode can be changed to big chain mode and changed mode is visible in running-config.
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest verify switch mode config  node=s1  mode=bigchain
    Should be true  ${result2}
    [Tags]  sanity  feature
        
TC004: Verify non-Trident 2 switches cannot be converted to big chain mode.
    ${result1}=  rest add switch role  node=s2  mode=bigchain
    Should not be true  ${result1}
    sleep  5
    ${result2}=  rest verify switch mode show  node=s2  mode=bigchain
    Should not be true  ${result2}
    [Tags]  sanity  feature  jira-bt-1820

TC005: Verify LLDP link discovery does not occur for switches in big chain mode
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest verify interswitch link  s1  s1
    Should not be true  ${result2}
    [Tags]  sanity  feature

TC006: Configure single chain without service and verify chain configuration in running-config
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    ${result4}=  rest verify bichain chain config  s1  chain_name=${chain_name}  endpoint1=${chain_interface_1}  endpoint2=${chain_interface_2}
    Should be true  ${result4}
    [Tags]  sanity  feature

TC007: Configure single chain without service and verify chain via cli command show bigchain chain
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC008: Configure single chain without service and verify chain via cli command show bigchain chain chain name
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC009: Configure single chain without service and verify chain via cli command show bigchain chain chain_name policy
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC010: Configure single chain without service and verify chain via cli command show bigchain policy
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC011: Configure single chain without service and verify chain via cli command show bigchain policy-flow
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC012: Delete chain configured in TC011 and verify chain is deleted in running-config.
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC013: Delete chain configured in TC011 and verify cli command show bigchain chain returns none.
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest add a chain  ${chain_name}
    Should be true  ${result2}
    sleep  1
    ${result3}=  rest add chain endpoint  node=s1  chain_name=${chain_name}  interface1=${chain_interface_1}  interface2=${chain_interface_2}
    Should be true  ${result3}
    sleep  1
    [Tags]  sanity  feature

TC014: Verify bigtap filter interface cannot be configured, via CLI, for a switch in bigchain mode
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role filter interface-name F1
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822

TC015: Verify bigtap delivery interface cannot be configured, via CLI, for a switch in bigchain mode
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role delivery interface-name D1
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822

TC016: Verify bigtap service interface cannot be configured, via CLI, for a switch in bigchain mode
    ${result1}=  rest add switch role  node=s1  mode=bigchain
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role service interface-name S1
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822

TC017: Verify switch mode cannot be changed to bigchain mode if filter interface is configured under switch.
    ${result1}=  rest add switch role  node=s1  mode=bigtap
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role filter interface-name F1
    config  node=master  cmd=exit
    config  node=master  cmd=deployment role bigchain
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822

TC018: Verify switch mode cannot be changed to bigchain mode if delivery interface is configured under switch.
    ${result1}=  rest add switch role  node=s1  mode=bigtap
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role delivery interface-name D1
    config  node=master  cmd=exit
    config  node=master  cmd=deployment role bigchain
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822

TC019: Verify switch mode cannot be changed to bigchain mode if service interface is configured under switch.
    ${result1}=  rest add switch role  node=s1  mode=bigtap
    Should be true  ${result1}
    sleep  5
    ${switch_dpid_s1}=  rest return switch dpid from ip  s1
    config  node=master  cmd=switch ${switch_dpid_s1}
    config  node=master  cmd=interface ethernet15
    config  node=master  cmd=bigtap role service interface-name S1
    config  node=master  cmd=exit
    config  node=master  cmd=deployment role bigchain
    ${content}=   cli_content   node=master
    Should contain  ${content}  Error
    [Tags]  sanity  feature  jira-bt-1822
    
* Keywords

sanity suite setup
    base suite setup
    rest add switch alias  s1  ${switch1_alias}
    rest add switch alias  s2  ${switch2_alias}
        
sanity test setup
    ${result1}=  write version to file
    Should be true  ${result1}
    ${result}=  start syslog monitor
    Should be true  ${result}
    ixia initialize  tg1  init=true
    
sanity test teardown
    config  node=master  cmd=no bigchain chain ${chain_name}
    delete traffic
    sleep  2
    ${result1}=  stop syslog monitor
    Should be true  ${result1}

sanity suite teardown
    ${result1}=  rest add switch role  node=s1  mode=bigtap
    Should be true  ${result1}
    sleep  5
    ${result2}=  rest verify switch mode show  node=s1  mode=bigtap-full-match
    Should be true  ${result2}
    rest delete switch alias  s1
    rest delete switch alias  s2
    rest delete switch  s1
    rest delete switch  s2
    base suite teardown