* Setting
Documentation   T5 intra tenant L3 Test Suite with IXIA Traffic Ports
Suite Setup     T5 base suite setup
Suite Teardown  T5 base suite teardown
Test Setup      test setup topology
Test Teardown   test teardown topology
Force Tags      T5      L3       IronHorse
Library         keywords/BsnCommon.py
Library         keywords/Host.py
Library         keywords/T5.py
Library         keywords/T5L3.py
Library         keywords/T5Platform.py
Library         keywords/T5Utilities.py
Library         Collections.py
Library         keywords/Ixia.py
Library         keywords/SwitchLight.py
Resource        testsuites/T5/L3/T5_L3_physical_intra/t5_layer3_physical_intra_variables.txt
Resource        testsuites/T5/t5_dualleaf_three_rack_physical_resource.txt


* Test Cases
Intra tenant L3 untagged traffic with dynamic endpoints same rack
    L3 intra tenant same rack untagged with dynamic endpoints
    [Tags]              feature           sanity                                                                                            
       
Trigger controller HA failover via reboot
    Controller HA failover via reboot
    [Tags]              feature                              

Spine connect and disconnect to controller
    Connect and Disconnect spine to controller
    [Tags]              feature       
    
Leaf connect and disconnect to controller   
    Connect and disconnect one leaf in dual tor to controller
    [Tags]              feature   

Spine to leaf link flap
    Flap link between leaf and spine
    [Tags]              feature           

Leaf to host link flap
    Flap bond interface towards host
    [Tags]              feature   
    
Restart ofad process on spine
    restart ofad on spine
    [Tags]              feature  
    
Restart ofad process on leaf    
    restart ofad on leaf
    [Tags]              feature           
    
L3 intra tenant traffic behavior in headless mode 
    manual passed
    [Tags]                  manual              feature                                 
                    
Trigger controller HA failover via CLI and verify dhcp-relay is working
    Trigger controller HA failover via CLI and verify dhcp-relay is working
    [Tags]                  feature         HA      dhcp-relay

Trigger controller HA failover via reboot and verify dhcp-relay is working
    Trigger controller HA failover via reboot and verify dhcp-relay is working
    [Tags]                  feature  run_fail         HA      dhcp-relay


Verify dhcp-relay functionality in headless mode
    manual passed
    [Tags]                  manual              feature                   dhcp-relay          

Verify ecmp forwarding in headless mode
    manual untested
    [Tags]                  manual          feature                   ecmp    
            
Verify L3 intra tenant forwarding after controller upgrade
    manual passed
    [Tags]                  manual          feature                   

Verify ecmp forwarding after controller upgrade
    manual passed
    [Tags]                  manual          feature                   

Verify dhcp-relay functionality after controller upgrade
    manual passed
    [Tags]                  manual          feature                         
    
Spine reboot
    Reboot spine0 via CLI
    [Tags]              feature           

Leaf reboot
    Reboot Leaf0 via CLI
    [Tags]              feature           

Trigger controller HA failover via CLI
    Controller HA failover via CLI  
    [Tags]              feature  
* Keywords
Controller HA failover via CLI
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1  
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=30
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
    Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0  
    ixia initialize  tg1  init=True      
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=100000           frame_size=128              frame_cnt=4000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1 
    start traffic                               ${stream1}
    sleep                                       5
    stop traffic                                ${stream1}
    verify results                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    start traffic                               ${stream1}
    sleep                                       10
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    ${value} =                                  REST verify cluster election take leader
    Should Be True                              ${value}
    sleep                                       5
    stop traffic                                ${stream1}
    verify results                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
    
L3 intra tenant same rack untagged with dynamic endpoints
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0   
    BASH ifup intf                              h5                              bond0   
    BASH ifup intf                              h6                              bond0           
    REST add portgroup to vns                   X                               X1                      ${leaf2_pc1}            -1
    REST add portgroup to vns                   X                               X2                      ${leaf2_pc2}            -1
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X2                      ${leaf1_a}              ${ixia3}                -1
    BASH ifconfig ip address                            h5                              10.251.1.11/24          bond0   
    BASH ifconfig ip address                            h6                              10.251.2.11/24          bond0
    BASH add route                              h5                              10.251.2.0/24           10.251.1.1
    BASH add route                              h6                              10.251.1.0/24           10.251.2.1
    sleep                                       5   
    BASH ping                                   h5                              10.251.1.1              count=10
    BASH ping                                   h6                              10.251.2.1              count=10
    ${value} =                                  BASH verify arp                 h5                      10.251.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h6                      10.251.2.1
    Should Be True                              ${value} 
    ${mac1} =                                   BASH get intf mac               h5                      bond0
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h6                      bond0
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints 
    ${loss} =                                   BASH ping                       h5                      10.251.2.11             count=10
    Should Be True                              ${loss} == 0    
    ixia initialize  tg1  init=True
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=100000           frame_size=9216             frame_cnt=10000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       dst_ip=10.251.2.201     dst_gw=10.251.2.1                       
    start traffic                               ${stream1}
    sleep  10
    stop traffic                                ${stream1}
    verify results                              transmitted_frames              received_frames         ${stream1}              stream1
    BASH delete route                           h5                              10.251.2.0/24           10.251.1.1
    BASH delete route                           h6                              10.251.1.0/24           10.251.2.1 


Controller HA failover via reboot
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1      
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
    Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0   
    ixia initialize  tg1  init=True     
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=100000           frame_size=128              frame_cnt=4000000
    ...                                         src_ip=10.251.1.101             src_cnt=10              src_ip_step=0.0.0.1     src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_cnt=10              dst_ip_step=0.0.0.1     dst_gw=10.251.3.1 
    start traffic                               ${stream1}
    sleep                                       10
    stop traffic                                ${stream1}
    verify results                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    start traffic                               ${stream1}
    sleep                                       10
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    ${value} =                                  CLI verify cluster master reboot
    Should Be True                              ${value}
    sleep                                       10
    stop traffic                                ${stream1}
    verify results                              transmitted_frames              received_valid_frames       ${stream1}              stream1 
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
    
        
Reboot spine0 via CLI
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0   
    BASH ifup intf                              h5                              bond0   
    BASH ifup intf                              h6                              bond0           
    REST add portgroup to vns                   X                               X1                      ${leaf2_pc1}            -1
    REST add portgroup to vns                   X                               X2                      ${leaf2_pc2}            -1
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X2                      ${leaf1_a}              ${ixia3}                -1
    BASH ifconfig ip address                            h5                              10.251.1.11/24          bond0   
    BASH ifconfig ip address                            h6                              10.251.2.11/24          bond0
    BASH add route                              h5                              10.251.2.0/24           10.251.1.1
    BASH add route                              h6                              10.251.1.0/24           10.251.2.1
    sleep                                       5   
    BASH ping                                   h5                              10.251.1.1              count=10
    BASH ping                                   h6                              10.251.2.1              count=10
    ${value} =                                  BASH verify arp                 h5                      10.251.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h6                      10.251.2.1
    Should Be True                              ${value} 
    ${mac1} =                                   BASH get intf mac               h5                      bond0
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h6                      bond0
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints 
    ${loss} =                                   BASH ping                       h5                      10.251.2.11             count=10
    Should Be True                              ${loss} == 0    
    ixia initialize  tg1  init=True
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=4000000
    ...                                         src_ip=10.251.1.101             src_cnt=10              src_ip_step=0.0.0.1     src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.2.101             dst_cnt=10              dst_ip_step=0.0.0.1     dst_gw=10.251.2.1                       
    start traffic                               ${stream1}
    sleep  10
    CLI restart switch                          s1
    sleep                                       10
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    sleep                                       5
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h5                              10.251.2.0/24           10.251.1.1
    BASH delete route                           h6                              10.251.1.0/24           10.251.2.1
    

Reboot Leaf0 via CLI
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0   
    BASH ifup intf                              h5                              bond0   
    BASH ifup intf                              h6                              bond0           
    REST add portgroup to vns                   X                               X1                      ${leaf2_pc1}            -1
    REST add portgroup to vns                   X                               X2                      ${leaf2_pc2}            -1
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X2                      ${leaf1_a}              ${ixia3}                -1
    BASH ifconfig ip address                            h5                              10.251.1.11/24          bond0   
    BASH ifconfig ip address                            h6                              10.251.2.11/24          bond0
    BASH add route                              h5                              10.251.2.0/24           10.251.1.1
    BASH add route                              h6                              10.251.1.0/24           10.251.2.1
    sleep                                       5   
    BASH ping                                   h5                              10.251.1.1              count=10
    BASH ping                                   h6                              10.251.2.1              count=10
    ${value} =                                  BASH verify arp                 h5                      10.251.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h6                      10.251.2.1
    Should Be True                              ${value} 
    ${mac1} =                                   BASH get intf mac               h5                      bond0
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h6                      bond0
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints 
    ${loss} =                                   BASH ping                       h5                      10.251.2.11             count=10
    Should Be True                              ${loss} == 0   
    ixia initialize  tg1  init=True 
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=2000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.2.101             dst_gw=10.251.2.1                       
    start traffic                               ${stream1}
    sleep  10
    CLI restart switch                          s3
    sleep                                       30 
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h5                              10.251.2.0/24           10.251.1.1
    BASH delete route                           h6                              10.251.1.0/24           10.251.2.1


Connect and Disconnect spine to controller
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0      
    ixia initialize  tg1  init=True  
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=2000000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1                       
    start traffic                               ${stream1}
    sleep                                       5
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    : FOR                                       ${i}                            IN RANGE                1                       5
    \   CLI delete controller                   s1                              c1
    \   CLI delete controller                   s1                              c2
    \   log traffic rate                        tx_rate                         rx_rate                 a                       c
    \   CLI add controller                      s1                              c1
    \   CLI add controller                      s1                              c2
    \   log traffic rate                        tx_rate                         rx_rate                 a                       c
    \   sleep                                   5
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
    

Connect and disconnect one leaf in dual tor to controller
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Not Be True                          ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    ixia initialize  tg1  init=True
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=2000000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1                       
    start traffic                               ${stream1}
    sleep                                       5
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    : FOR                                       ${i}                            IN RANGE                1                       5
    \   CLI delete controller                   s3                              c1
    \   CLI delete controller                   s3                              c2
    \   CLI add controller                      s3                              c1
    \   CLI add controller                      s3                              c2
    \   log traffic rate                        tx_rate                         rx_rate                 a                       c
    \   sleep                                   5
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
        

Flap link between leaf and spine
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0       
    ixia initialize  tg1  init=True 
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=4000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1                       
    start traffic                               ${stream1}
    sleep                                       5
#    CLI disable interface                       s3                              ${leaf0a_spine0}    
    REST disable fabric interface               ${leaf0_a}                       ${leaf0a_spine0}
   
    sleep                                       5   
    log traffic rate                            tx_rate                         rx_rate                 a                       c
#    CLI enable interface                        s3                              ${leaf0a_spine0}    
    REST enable fabric interface                ${leaf0_a}                              ${leaf0a_spine0}
    sleep                                       10
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
        

Flap bond interface towards host
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}
    ${attachpoint} =                            Set Variable                    ${result[0]['attachment-point']}    
    Should Contain                              ${attachpoint}                  ${leaf0_pc1}
    ${vlanid} =                                 Set Variable                    ${result[0]['vlan']}    
    Should Be Equal                             ${vlanid}                       ${1001}     
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    REST disable fabric interface               ${leaf0_a}                         ${leaf0_pc1_intf1}
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}
    ${attachpoint} =                            Set Variable                    ${result[0]['attachment-point']}    
    Should Contain                              ${attachpoint}                  ${leaf0_pc1}
    ${vlanid} =                                 Set Variable                    ${result[0]['vlan']}    
    Should Be Equal                             ${vlanid}                       ${1001}     
    sleep                                       5
    REST disable fabric interface               ${leaf0_b}                         ${leaf0_pc1_intf1}
    sleep                                       2   
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Not Be True                          ${result}
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 100      
    sleep                                       1
    REST enable fabric interface                ${leaf0_a}                         ${leaf0_pc1_intf1}
    REST enable fabric interface                ${leaf0_b}                         ${leaf0_pc1_intf1}
    BASH ping                                   h1                              10.251.3.11             count=5
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}
    ${attachpoint} =                            Set Variable                    ${result[0]['attachment-point']}    
    Should Contain                              ${attachpoint}                  ${leaf0_pc1}
    ${vlanid} =                                 Set Variable                    ${result[0]['vlan']}    
    Should Be Equal                             ${vlanid}                       ${1001}     
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1


restart ofad on spine
    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                            h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                            h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    ixia initialize  tg1  init=True
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=2000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1                       
    start traffic                               ${stream1}
    sleep                                       5
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    BASH restart process                        s1                              ofad                    timeout=60
    sleep                                       5
    reconnect switch ips
    ${value} =                                  bash execute command       s1                      service ofad status
    Should Contain                              ${value}                        is running
    sleep                                       10
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    sleep                                       10
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1


restart ofad on leaf
#### restart ofad will reset all interfaces to 10gig, need to manaully adjust interface to autoneg for Ixia port for traffic to resume

    BASH ifup intf                              h1                              bond0
    BASH ifup intf                              h2                              bond0
    BASH ifup intf                              h3                              bond0
    BASH ifup intf                              h4                              bond0
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0   
    REST add portgroup to vns                   X                               X1                      ${leaf0_pc1}            1001
    REST add portgroup to vns                   X                               X3                      ${leaf1_pc1}            1003
    REST add interface to vns                   X                               X1                      ${leaf0_a}              ${ixia1}                -1
    REST add interface to vns                   X                               X3                      ${leaf1_a}              ${ixia3}                -1
    BASH add tag                                h1                              bond0                   1001
    BASH add tag                                h3                              bond0                   1003
    BASH ifup intf                              h1                              bond0.1001
    BASH ifup intf                              h3                              bond0.1003
    BASH ifconfig ip address                    h1                              10.251.1.11/24          bond0.1001
    BASH ifconfig ip address                    h3                              10.251.3.11/24          bond0.1003
    BASH add route                              h1                              10.251.3.0/24           10.251.1.1
    BASH add route                              h3                              10.251.1.0/24           10.251.3.1
    sleep                                       5   
#    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#    Should Not Be True                          ${value}        
#    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#    Should Not Be True                          ${value}    
    BASH ping                                   h1                              10.251.3.11             count=10
    ${value} =                                  BASH verify arp                 h1                      10.251.1.1
#   Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h3                      10.251.3.1
#   Should Be True                              ${value}        
    ${mac1} =                                   BASH get intf mac               h1                      bond0.1001
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h3                      bond0.1003
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints     
    ${loss} =                                   BASH ping                       h1                      10.251.3.11             count=10
    Should Be True                              ${loss} == 0        
    ixia initialize  tg1  init=True
    ${stream1}=                                 L3 add                          name=stream1            flow=a<->c              frame_rate=10000            frame_size=128              frame_cnt=2000000
    ...                                         src_ip=10.251.1.101             src_gw=10.251.1.1       
    ...                                         dst_ip=10.251.3.101             dst_gw=10.251.3.1                       
    start traffic                               ${stream1}
    sleep                                       5
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    BASH restart process                        s3                              ofad
    sleep                                       5
#   CLI execute command                         s3                              debug ofad "autoneg 24"
#   sleep                                       1
    reconnect switch ips
    ${value} =                                  bash execute command       s3                      service ofad status
    sleep                                       10
    verify traffic rate                         tx_rate                         rx_rate                 a                       c
    sleep                                       10
    stop traffic                                ${stream1}
    calculate loss                              transmitted_frames              received_valid_frames       ${stream1}              stream1
    BASH delete route                           h1                              10.251.3.0/24           10.251.1.1
    BASH delete route                           h3                              10.251.1.0/24           10.251.3.1
    

Trigger controller HA failover via CLI and verify dhcp-relay is working
    BASH ifdown intf                            h1                              bond0
    BASH ifdown intf                            h2                              bond0
    BASH ifdown intf                            h3                              bond0
    BASH ifdown intf                            h4                              bond0   
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0       
#    BASH init intf                              h1                              bond0
#    BASH init intf                              h2                              bond0
    BASH ifup intf                              h1                              bond0
    BASH ifconfig ip address                    h1                              10.252.1.9/24           bond0                   
    BASH start service                          h1                              isc-dhcp-server
    BASH ping                                   h1                              10.252.1.1              count=4
    sleep                                       1
    ${value} =                                  BASH check service status       h1                      isc-dhcp-server
    Should Contain                              ${value}                        is started
    sleep                                       1
    REST add portgroup to vns                   Y                               Y1                      ${leaf0_pc1}            -1
    REST add portgroup to vns                   Y                               Y3                      ${leaf2_pc1}            -1
    BASH add route                              h1                              10.252.3.0/24           10.252.1.1
    REST add dhcp relay                         Y                               Y3                      10.252.1.9
    #REST enable dhcp relay                     Y                               Y3  
    sleep                                       5
    BASH ping                                   h1                              10.252.1.1              count=5
    ${h1_ip} =                                  BASH get interface ipv4         h1                      bond0               
    Should Contain                              ${h1_ip}                        10.252.1.9  
    ${h1_mac} =                                 BASH get intf mac               h1                      bond0
    ${result} =                                 REST show endpoints mac         ${h1_mac}
    Should Not Be Empty                         ${result}
    sleep                                       1
    ## temporary fix
    BASH ping                                   h1                              10.252.1.1              count=5
    sleep                                       1
    ${value} =                                  BASH verify arp                 h1                      10.252.1.1
    Should Be True                              ${value}        
    sleep                                       1
    ${value} =                                  BASH release dhcpv4 address     h5                      bond0
    Should Be True                              ${value}
    sleep                                       1
    ${ipAddr} =                                 BASH renew dhcpv4 address       h5                      bond0
    Should Not Be Empty                         ${ipAddr}
    sleep                                       10
    BASH ping                                   h1                              ${ipAddr}               count=10
    ${value} =                                  BASH verify arp                 h1                      10.252.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h5                      10.252.3.1
    Should Be True                              ${value}    
    ${mac1} =                                   BASH get intf mac               h1                      bond0
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h5                      bond0
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints 
    ${loss} =                                   BASH ping                       h1                      ${ipAddr}           count=10
    Should Be True                              ${loss} == 0    
    ${value} =                                  REST verify cluster election take leader
    Should Be True                              ${value}
    sleep                                       10
    ${value} =                                  BASH release dhcpv4 address     h5                      bond0
    Should Be True                              ${value}
    sleep                                       1
    ${ipAddr} =                                 BASH renew dhcpv4 address       h5                      bond0
    Should Not Be Empty                         ${ipAddr}
    sleep                                       5
    bash run command                                h5                             route -n
    BASH ping                                   h1                              ${ipAddr}               count=10
    ${loss} =                                   BASH ping                       h1                      ${ipAddr}           count=10
    Should Be True                              ${loss} == 0    
    BASH delete route                           h1                              10.252.3.0/24           10.252.1.1
    
Trigger controller HA failover via reboot and verify dhcp-relay is working
    BASH ifdown intf                            h1                              bond0
    BASH ifdown intf                            h2                              bond0
    BASH ifdown intf                            h3                              bond0
    BASH ifdown intf                            h4                              bond0   
    BASH ifup intf                              h5                              bond0
    BASH ifup intf                              h6                              bond0       
#    BASH init intf                              h1                              bond0
#    BASH init intf                              h2                              bond0
    BASH ifup intf                              h1                              bond0
    BASH ifconfig ip address                    h1                              10.252.1.9/24           bond0                   
    BASH start service                          h1                              isc-dhcp-server
    BASH ping                                   h1                              10.252.1.1              count=4
    sleep                                       1
    ${value} =                                  BASH check service status       h1                      isc-dhcp-server
    Should Contain                              ${value}                        is started
    sleep                                       1
    REST add portgroup to vns                   Y                               Y1                      ${leaf0_pc1}            -1
    REST add portgroup to vns                   Y                               Y3                      ${leaf2_pc1}            -1
    BASH add route                              h1                              10.252.3.0/24           10.252.1.1
    REST add dhcp relay                         Y                               Y3                      10.252.1.9
    #REST enable dhcp relay                     Y                               Y3  
    sleep                                       1
    ${value} =                                  BASH release dhcpv4 address     h5                      bond0
    Should Be True                              ${value}
    sleep                                       1
    ${ipAddr} =                                 BASH renew dhcpv4 address       h5                      bond0
    Should Not Be Empty                         ${ipAddr}
    sleep                                       2
    BASH ping                                   h1                              ${ipAddr}               count=10
    ${value} =                                  BASH verify arp                 h1                      10.252.1.1
    Should Be True                              ${value}        
    ${value} =                                  BASH verify arp                 h5                      10.252.3.1
    Should Be True                              ${value}    
    ${mac1} =                                   BASH get intf mac               h1                      bond0
    ${result} =                                 REST show endpoints mac         ${mac1}
    Should Be True                              ${result}                       
    ${mac2} =                                   BASH get intf mac               h5                      bond0
    ${result} =                                 REST show endpoints mac         ${mac2}
    Should Be True                              ${result}                       
    REST show endpoints 
    ${loss} =                                   BASH ping                       h1                      ${ipAddr}           count=10
    Should Be True                              ${loss} == 0    
    ${value} =                                  CLI verify cluster master reboot
    Should Be True                              ${value}
    sleep                                       10
    ${value} =                                  BASH release dhcpv4 address     h5                      bond0
    Should Be True                              ${value}
    sleep                                       1
    ${ipAddr} =                                 BASH renew dhcpv4 address       h5                      bond0
    Should Not Be Empty                         ${ipAddr}
    sleep                                       10
    BASH ping                                   h1                              ${ipAddr}               count=10
    ${loss} =                                   BASH ping                       h1                      ${ipAddr}           count=10
    Should Be True                              ${loss} == 0    
    BASH delete route                           h1                              10.252.3.0/24           10.252.1.1        
    
initialize host
    BASH delete tag                             h1                              bond0.1001              soft_error=${true}
    BASH delete tag                             h2                              bond0.1002              soft_error=${true}
    BASH delete tag                             h3                              bond0.1003              soft_error=${true}
    BASH delete tag                             h4                              bond0.1004              soft_error=${true}
    BASH delete tag                             h5                              bond0.1005              soft_error=${true}
    BASH delete tag                             h6                              bond0.1006              soft_error=${true}
    BASH init intf                              h1                              eth1
    BASH init intf                              h1                              eth2
    BASH init intf                              h1                              eth3
    BASH init intf                              h2                              eth1
    BASH init intf                              h2                              eth2
    BASH init intf                              h2                              eth3
    BASH init intf                              h3                              eth1
    BASH init intf                              h3                              eth2
    BASH init intf                              h3                              eth3
    BASH init intf                              h4                              eth1
    BASH init intf                              h4                              eth2
    BASH init intf                              h4                              eth3
    BASH init intf                              h5                              eth1
    BASH init intf                              h5                              eth2
    BASH init intf                              h5                              eth3
    BASH init intf                              h6                              eth1
    BASH init intf                              h6                              eth1
    BASH init intf                              h6                              eth2
    BASH init intf                              h6                              eth3
    BASH init intf                              h1                              bond0
    BASH init intf                              h2                              bond0
    BASH init intf                              h3                              bond0
    BASH init intf                              h4                              bond0
    BASH init intf                              h5                              bond0
    BASH init intf                              h6                              bond0
    BASH run command                            h1                              ifdown bond0
    BASH run command                            h2                              ifdown bond0
    BASH run command                            h3                              ifdown bond0
    BASH run command                            h4                              ifdown bond0
    BASH run command                            h5                              ifdown bond0
    BASH run command                            h6                              ifdown bond0
    BASH run command                            h1                              ifup eth2
    BASH run command                            h1                              ifup eth3
    BASH run command                            h1                              ifup eth3
    BASH run command                            h1                              ifup eth3
    BASH run command                            h2                              ifup eth2
    BASH run command                            h2                              ifup eth3
    BASH run command                            h2                              ifup eth3
    BASH run command                            h2                              ifup eth3
    BASH run command                            h3                              ifup eth2
    BASH run command                            h3                              ifup eth3
    BASH run command                            h3                              ifup eth3
    BASH run command                            h3                              ifup eth3
    BASH run command                            h4                              ifup eth2
    BASH run command                            h4                              ifup eth3
    BASH run command                            h4                              ifup eth3
    BASH run command                            h4                              ifup eth3
    BASH run command                            h5                              ifup eth2
    BASH run command                            h5                              ifup eth3
    BASH run command                            h5                              ifup eth3
    BASH run command                            h5                              ifup eth3
    BASH run command                            h6                              ifup eth2
    BASH run command                            h6                              ifup eth3
    BASH run command                            h6                              ifup eth3
    BASH run command                            h6                              ifup eth3
    BASH release dhcpv4 address                 h1                              bond0
    BASH release dhcpv4 address                 h2                              bond0
    BASH release dhcpv4 address                 h3                              bond0
    BASH release dhcpv4 address                 h4                              bond0
    BASH release dhcpv4 address                 h5                              bond0
    BASH release dhcpv4 address                 h6                              bond0
    BASH kill process                           h1                              dhclient
    BASH kill process                           h2                              dhclient
    BASH kill process                           h3                              dhclient
    BASH kill process                           h4                              dhclient
    BASH kill process                           h5                              dhclient
    BASH kill process                           h6                              dhclient
    ${result} =                                 BASH run command                h1                     ifconfig
    log                                         host1 ifconfig is ${result}
    ${result} =                                 BASH run command                h2                     ifconfig
    log                                         host2 ifconfig is ${result}
    ${result} =                                 BASH run command                h3                     ifconfig
    log                                         host3 ifconfig is ${result}
    ${result} =                                 BASH run command                h4                     ifconfig
    log                                         host4 ifconfig is ${result}
    ${result} =                                 BASH run command                h5                     ifconfig
    log                                         host5 ifconfig is ${result}
    ${result} =                                 BASH run command                h6                     ifconfig
    log                                         host6 ifconfig is ${result}
    BASH stop service                           h1                              isc-dhcp-server
    
    


test setup topology
    initialize host
    sleep                                           1
#   Start Floodlight Monitor 
    REST add tenant                                 X
    REST add tenant                                 Y
    REST add tenant                                 Z
    REST add vns                                    X                           X1
    REST add vns                                    X                           X2
    REST add vns                                    X                           X3
    REST add vns                                    Y                           Y1
    REST add vns                                    Y                           Y2
    REST add vns                                    Y                           Y3
    REST add vns                                    Z                           Z1
    REST add vns                                    Z                           Z2
    REST add vns                                    Z                           Z3
    REST add router intf                            X                           X1
    REST add router intf                            X                           X2
    REST add router intf                            X                           X3
    REST add router intf                            Y                           Y1
    REST add router intf                            Y                           Y2
    REST add router intf                            Y                           Y3
    REST add router intf                            Z                           Z1
    REST add router intf                            Z                           Z2
    REST add router intf                            Z                           Z3
    REST add vns ip                                 X                           X1              10.251.1.1              24  
    REST add vns ip                                 X                           X2              10.251.2.1              24  
    REST add vns ip                                 X                           X3              10.251.3.1              24  
    REST add vns ip                                 Y                           Y1              10.252.1.1              24  
    REST add vns ip                                 Y                           Y2              10.252.2.1              24  
    REST add vns ip                                 Y                           Y3              10.252.3.1              24  
    REST add vns ip                                 Z                           Z1              10.253.1.1              24  
    REST add vns ip                                 Z                           Z2              10.253.2.1              24  
    REST add vns ip                                 Z                           Z3              10.253.3.1              24  

 
test teardown topology
	base test teardown
    stop traffic                                   
    sleep                                           1
    delete traffic
    REST delete vns ip                              X                           X1              10.251.1.1              24  
    REST delete vns ip                              X                           X2              10.251.2.1              24  
    REST delete vns ip                              X                           X3              10.251.3.1              24  
    REST delete vns ip                              Y                           Y1              10.252.1.1              24  
    REST delete vns ip                              Y                           Y2              10.252.2.1              24  
    REST delete vns ip                              Y                           Y3              10.252.3.1              24  
    REST delete vns ip                              Z                           Z1              10.253.1.1              24  
    REST delete vns ip                              Z                           Z2              10.253.2.1              24  
    REST delete vns ip                              Z                           Z3              10.253.3.1              24  
    REST delete vns                                 X                           X1
    REST delete vns                                 X                           X2
    REST delete vns                                 X                           X3
    REST delete vns                                 Y                           Y1
    REST delete vns                                 Y                           Y2
    REST delete vns                                 Y                           Y3
    REST delete vns                                 Z                           Z1
    REST delete vns                                 Z                           Z2
    REST delete vns                                 Z                           Z3
    REST delete tenant                              X
    REST delete tenant                              Y
    REST delete tenant                              Z
#   Stop Floodlight Monitor 
    initialize host
    BASH ifdown intf                                    h3                          bond0
    BASH restart networking service                 h1                          timeout=60
    BASH restart networking service                 h3                          timeout=60
    BASH restart networking service                 h6                          timeout=60


T5 base suite setup
    base suite setup
    fabric infra suite setup
    Set host int variables
    reconnect_switch_ips
    #BASH network restart                            h1                                timeout=60
    #BASH network restart                            h2                                timeout=60
    #BASH network restart                            h3                                timeout=60
    #BASH network restart                            h4                                timeout=60
    #BASH network restart                            h5                                timeout=60
    #BASH restart service                            h6                                networking              timeout=60   
    sleep                                           5
    ${result} =                                     CLI verify controller       s1                          c1      
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s1                          c2
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s2                          c1
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s2                          c2
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s3                          c1
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s3                          c2
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s4                          c1
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s4                          c2
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s5                          c1
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s5                          c2
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s6                          c1
    Should Be True                                  ${result}
    ${result} =                                     CLI verify controller       s6                          c2
    Should Be True                                  ${result}       
    REST add portgroup                              ${leaf0_pc1}
    REST add portgroup                              ${leaf0_pc2}
    REST add portgroup                              ${leaf1_pc1}
    REST add portgroup                              ${leaf1_pc2}
    REST add portgroup                              ${leaf2_pc1}
    REST add portgroup                              ${leaf2_pc2}
    REST add interface to portgroup                 leaf0-a                     ${leaf0_pc1_intf1}                  ${leaf0_pc1}
    REST add interface to portgroup                 leaf0-b                     ${leaf0_pc1_intf2}                  ${leaf0_pc1}
    REST add interface to portgroup                 leaf0-a                     ${leaf0_pc2_intf1}                  ${leaf0_pc2}
    REST add interface to portgroup                 leaf0-b                     ${leaf0_pc2_intf2}                  ${leaf0_pc2}
    REST add interface to portgroup                 leaf1-a                     ${leaf1_pc1_intf1}                  ${leaf1_pc1}
    REST add interface to portgroup                 leaf1-b                     ${leaf1_pc1_intf2}                  ${leaf1_pc1}
    REST add interface to portgroup                 leaf1-a                     ${leaf1_pc2_intf1}                  ${leaf1_pc2}
    REST add interface to portgroup                 leaf1-b                     ${leaf1_pc2_intf2}                  ${leaf1_pc2}
    REST add interface to portgroup                 leaf2-a                     ${leaf2_pc1_intf1}                  ${leaf2_pc1}
    REST add interface to portgroup                 leaf2-b                     ${leaf2_pc1_intf2}                  ${leaf2_pc1}
    REST add interface to portgroup                 leaf2-a                     ${leaf2_pc2_intf1}                  ${leaf2_pc2}
    REST add interface to portgroup                 leaf2-b                     ${leaf2_pc2_intf2}                  ${leaf2_pc2}    
    REST add portgroup lacp                         ${leaf0_pc1}
    REST add portgroup lacp                         ${leaf0_pc2}
    REST add portgroup lacp                         ${leaf1_pc1}
    REST add portgroup lacp                         ${leaf1_pc2}
    REST add portgroup lacp                         ${leaf2_pc1}
    REST add portgroup lacp                         ${leaf2_pc2}
 
  
T5 base suite teardown
    delete fabric switch  
    #BASH network restart                            h1                                timeout=60
    #BASH network restart                            h2                                timeout=60
    #BASH network restart                            h3                                timeout=60
    #BASH network restart                            h4                                timeout=60
    #BASH network restart                            h5                                timeout=60
    #BASH restart service                            h6                                networking              timeout=60
    REST delete portgroup lacp                          ${leaf0_pc1}
    REST delete portgroup lacp                          ${leaf0_pc2}
    REST delete portgroup lacp                          ${leaf1_pc1}
    REST delete portgroup lacp                          ${leaf1_pc2}
    REST delete portgroup lacp                          ${leaf2_pc1}
    REST delete portgroup lacp                          ${leaf2_pc2}    
    REST delete portgroup                               ${leaf0_pc1}
    REST delete portgroup                               ${leaf0_pc2}
    REST delete portgroup                               ${leaf1_pc1}
    REST delete portgroup                               ${leaf1_pc2}
    REST delete portgroup                               ${leaf2_pc1}
    REST delete portgroup                               ${leaf2_pc2}


verify results   [Arguments]  ${transmitted_frames}  ${received_valid_frames}  ${stream}  ${stream_name}
    Sleep  5
    ${report}=  fetch port stats  stream=${stream}  
    ${tx_value}=  verify dict key  ${report}  ${stream_name}  ${transmitted_frames}
    ${rx_value}=  verify dict key  ${report}  ${stream_name}  ${received_valid_frames}
    ${in_range}=  ixia verify traffic rate  ${tx_value}  ${rx_value} 
    Log         ${in_range}
   Should be true  ${in_range}  
    
calculate loss   [Arguments]  ${transmitted_frames}  ${received_valid_frames}  ${stream}  ${stream_name}
    Sleep  5
    ${report} =     fetch port stats    stream=${stream}  
    ${tx_value} =   verify dict key     ${report}  ${stream_name}  ${transmitted_frames}
    ${rx_value} =   verify dict key     ${report}  ${stream_name}  ${received_valid_frames}
    ${loss} =       evaluate            ${tx_value} - ${rx_value}
    Log             ${loss}
    
verify traffic rate   [Arguments]  ${tx_rate}  ${rx_rate}  ${tx_intf}  ${rx_intf}
    Sleep  5
    ${report}=  fetch port stats
    Log     ${report}
    ${tx_value}=  verify dict key  ${report}  ${tx_intf}  transmitted_frame_rate
    ${rx_value}=  verify dict key  ${report}  ${rx_intf}  received_valid_frame_rate
    ixia verify traffic rate  ${tx_value}  ${rx_value} 

log traffic rate   [Arguments]  ${tx_rate}  ${rx_rate}  ${tx_intf}  ${rx_intf}
    Sleep  5
    ${report}=  fetch port stats
    Log     ${report}
    ${tx_value}=  verify dict key  ${report}  ${tx_intf}  transmitted_frame_rate
    ${rx_value}=  verify dict key  ${report}  ${rx_intf}  received_valid_frame_rate
    Log     ${tx_value}
    Log     ${rx_value} 
 

    
