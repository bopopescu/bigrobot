* Settings
Documentation    T5 Test Suite
Suite Setup      T5 longevity suite setup
Suite Teardown   T5 longevity suite teardown
Test Setup       base test setup 
Test Teardown    base test teardown 
Force Tags       IronHorse   T5
Library          keywords/BsnCommon.py
Library          keywords/Controller.py
Library			 keywords/Mininet.py
Library		     keywords/Host.py
Library		     keywords/Ixia.py
Library		     keywords_dev/mingtao/T5_longevity.py
Library	         keywords/T5.py
Library          keywords/T5L3.py
Library	         keywords/T5Platform.py
Library	         keywords/Controller.py
Library	         keywords/SwitchLight.py
Library	         keywords/T5Utilities.py

Library          OperatingSystem
 
* Variable
${short}  1
${medium}  3
${long}   30
${verylong}     120 
${inevent}       300 
${betweenevent}  60

${Tflapnum}     50 
${Vflapnum}     50 
${bigconfigsleep}  300 


${loop}    2
${repeat}      10


${leaf1-a}     dt-leaf1a
${leaf1-b}     dt-leaf1b
${leaf2-a}     dt-leaf2a
${leaf2-b}     dt-leaf2b
 
${spine1}      dt-spine1
${spine2}      dt-spine2
 
* Test Case
 
 

T21 spine switch node down/up event 	 
    : FOR    ${i}    IN RANGE    0    ${loop}
    \	Log To Console   \n******* spine switch node down/up event: ${i}********   
    \	switch node down/up event      spine1 
    \   sleep  ${inevent}
    \	switch node down/up event      spine2  
    \   sleep  ${inevent}  
       
	[Tags] 	longevity   traffic    event     skipped
	    
T23 controller node event failover        
     : FOR    ${i}    IN RANGE    0    ${loop}
    \	Log To Console   \n******* controller node failover: ${i}*******    
    \	controller node event HA failover     ${inevent}
    \   sleep   ${inevent}
        
	[Tags] 	longevity    traffic     event    skipped
 



T27 data Link down/up event between leaf and spine
    : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* data Link down/up event between leaf and spine ${i}******* 
	\  data Link down/up event between nodes  ${leaf1-a}    ${spine1} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${spine1}    ${leaf1-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-b}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf1-b} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-a}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf1-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-b}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}   ${leaf1-b} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-a}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf2-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-b}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf2-b} 	
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-a}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf2-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-b}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf2-b} 
	\  sleep  ${inevent}  
 
 
	[Tags] 	longevity     traffic     event

T28 data Link down/up event between leafs 
    : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* date link down/up ${i}******* 
	\  data Link down/up event between nodes  ${leaf1-a}    ${leaf1-b} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf1-b}    ${leaf1-a} 
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf2-a}    ${leaf2-b} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf2-b}    ${leaf2-a} 
	\  sleep  ${inevent}  		
   
	[Tags] 	 longevity   traffic   event   

 
T26 big configuration changes (around 500 tenants or vns change)
     : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* big configuration changes ${i}******* 
 	\  tenant configuration add/remove      ${Tflapnum}       3       
 	\  sleep  ${bigconfigsleep}  
 	\  vns configuration add/remove         ${Vflapnum}               
 	\  sleep  ${bigconfigsleep}  
  	
	[Tags] 	longevity     traffic    event     

 	
	 
T51 continues Event
   	log  randomize all the event test cases from T23 to T30
    ${loop}=  Set Variable   1	
    : FOR   ${index}    IN RANGE    0    ${repeat}	
	\  Log To Console   "\n========******* in continues event loop: ${index} out of 1000 ******====== " 
	\  ${random}=	Evaluate	 random.randint(1,3)    random,sys
	\  Log To Console   "--------random number is ${random} --------" 
	\  Run Keyword if    ${random}==1   T27 data Link down/up event between leaf and spine       
	\  Run Keyword if    ${random}==2   T28 data Link down/up event between leafs 
 	\  Run Keyword if    ${random}==3   T26 big configuration changes (around 500 tenants or vns change) 
  	\  sleep  ${betweenevent}
   
	[Tags] 	longevity    traffic    skipped


 

	  

* Keywords

switch node down/up event   [Arguments]    ${node}
	log  reload switch
	Log To Console   ================ Rebooting ${node} ===============
	cli_restart_switch  ${node}   yes	

 
 
controller node event HA failover    [Arguments]    ${during}=30
    Log To Console   =============HA failover ===============
    cli_cluster_take_leader
    sleep  ${during}    
    clear stats in controller switch	  

controller node event reboot master    [Arguments]    ${during}=30
    Log To Console   ================ Rebooting controller ===============
    cli_verify_cluster_master_reboot 
    sleep  ${during}
 
controller node event reboot slave    [Arguments]    ${during}=30
    Log To Console   ================ Rebooting controller ===============
    cli_verify_cluster_slave_reboot 
    sleep  ${during}


data Link down/up event between nodes   [Arguments]    ${node1}    ${node2}
    Log To Console   ================ data link down/up for ${node1} ${node2} ===============
	log  disable/enable link from leaf to spine			 
	${list}=  disable links between nodes   ${node1}    ${node2}
	log   list is ${list} 
 	sleep    ${medium}  	
	enable links between nodes 	${node1}   ${list}


disable links between nodes    [Arguments]   ${node1}   ${node2} 
	${list}=    cli_get_links_nodes_list     ${node1}   ${node2} 
 	: FOR    ${int}   IN   @{list}   
	\  	rest_disable_fabric_interface		${node1}  ${int}  
	\   sleep  ${medium}
 	Return From Keyword   ${list}

enable links between nodes   [Arguments]   ${node1}   ${list} 
 	: FOR    ${int}   IN   @{list}   
	\  	rest_enable_fabric_interface		${node1}  ${int}  
	\   sleep  ${medium}



 
tenant configuration add/remove    [Arguments]    ${Tnumber}   ${Vnumber}    ${sleep}=1
    Log To Console   ================tenant configuration changes: ${Tnumber}===============
 	clear stats in controller switch	     
	enable  master  copy running-config config://config_tenant_old
	log  big scale configuration tenant add	
	rest_add_tenant_vns_scale    tenantcount=${Tnumber}   tname=FLAP     vnscount=${Vnumber}   vns_ip=yes  base=1.1.1.1    step=0.0.1.0		 
	${vlan}=    Set Variable   1000
    : FOR    ${j}    IN RANGE    0     ${Tnumber}
    \	rest_add_interface_to_all_vns      FLAP${j}     leaf0-a    ethernet3  vlan=${vlan}	 
    \   rest_add_l3_endpoint_to_all_vns       FLAP${j}     leaf0-a    ethernet3  vlan=${vlan}  
    \   ${vlan}=  expr  ${vlan} + ${Vnumber}
	\   sleep   ${sleep}
	cli    master     show running-config tenant
	enable  master  copy running-config config://config_tenant_new	
	log  big scale configuration tenant delete
	
    : FOR    ${j}    IN RANGE    0     ${Tnumber}
    \ 	config    master     no tenant FLAP${j}
    
	cli    master     show running-config tenant
   	

vns configuration add/remove    [Arguments]   ${Vnumber}      ${sleep}=1
    Log To Console   ================ vns configuration changes: ${Vnumber}===============
	enable  master  copy running-config config://config_vns_old
	${vlan}=    Set Variable   1000    
	rest_add_tenant_vns_scale    tenantcount=1   tname=FLAP    vnscount=${Vnumber}   vns_ip=yes  base=1.1.1.1    step=0.0.1.0		 
	rest_add_interface_to_all_vns      FLAP0     leaf0-a    ethernet3   vlan=${vlan}	
	sleep   ${sleep}	 
	cli    master     show running-config tenant	
	enable  master  copy running-config config://config_vns_new
	
 	log  big scale configuration tenant delete
 	config    master   tenant FLAP0
	${vns}=  expr  1 + ${Vnumber}
    : FOR    ${j}    IN RANGE    1     ${vns}
    \ 	config    master    no segment V${j}
	config    master   logical-router    
    : FOR    ${j}    IN RANGE    1     ${vns}
    \ 	config    master    no interface segment V${j}   
	config    master    no tenant FLAP0      
	cli    master     show running-config tenant		
 

clear stats in controller switch
	cli_clear_interface_statistics   s1	
	cli_clear_interface_statistics   s2
	cli_clear_interface_statistics   s3	
	cli_clear_interface_statistics   s4
	cli_clear_interface_statistics   s5	
	cli_clear_interface_statistics   s6	
	cli_clear_interface_statistics   s7
#	cli_clear_interface_statistics   s8		
#	rest_clear_vns_stats
	rest_clear_fabric_interface_stats
 
T5 longevity suite setup
   base suite setup
    : FOR    ${j}    IN RANGE    0     500
    \ 	config    master     no tenant FLAP${j}

T5 longevity suite teardown
#   base suite teardown
	sleep  1
 
 
verify switch interface is up	[Arguments]  ${switch}   ${intf}  
	${info}=  rest_get_fabric_interface_info   ${switch}  ${intf}
	Should Be Equal as Strings 		up      ${info['state']}
 
 
 
######## test case keyword

T21 spine switch node down/up event 	 
    : FOR    ${i}    IN RANGE    0    ${loop}
    \	Log To Console   \n******* spine switch node down/up event: ${i}********   
    \	switch node down/up event      spine1 
    \   sleep  ${inevent}
    \	switch node down/up event      spine2  
    \   sleep  ${inevent}  
  	    
T23 controller node event failover        
     : FOR    ${i}    IN RANGE    0    ${loop}
    \	Log To Console   \n******* controller node failover: ${i}*******    
    \	controller node event HA failover     ${inevent}
    \   sleep   ${inevent}
        
	 



T27 data Link down/up event between leaf and spine
    : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* data Link down/up event between leaf and spine ${i}******* 
	\  data Link down/up event between nodes  ${leaf1-a}    ${spine1} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${spine1}    ${leaf1-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-b}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf1-b} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-a}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf1-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf1-b}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}   ${leaf1-b} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-a}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf2-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-b}    ${spine1} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine1}    ${leaf2-b} 	
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-a}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf2-a} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${leaf2-b}    ${spine2} 
	\  sleep  ${inevent}  	
	\  data Link down/up event between nodes  ${spine2}    ${leaf2-b} 
	\  sleep  ${inevent}  
 
  
T28 data Link down/up event between leafs 
    : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* date link down/up ${i}******* 
	\  data Link down/up event between nodes  ${leaf1-a}    ${leaf1-b} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf1-b}    ${leaf1-a} 
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf2-a}    ${leaf2-b} 	
	\  sleep  ${inevent}  
	\  data Link down/up event between nodes  ${leaf2-b}    ${leaf2-a} 
	\  sleep  ${inevent}  		
  
 
T26 big configuration changes (around 500 tenants or vns change)
     : FOR    ${i}    IN RANGE    0    ${loop}
    \  Log To Console   \n******* big configuration changes ${i}******* 
 	\  tenant configuration add/remove      ${Tflapnum}       3       
 	\  sleep  ${bigconfigsleep}  
 	\  vns configuration add/remove         ${Vflapnum}               
 	\  sleep  ${bigconfigsleep}  
   
 	