* Settings
Documentation    T5 upgrade Test Suite
Suite Setup      Upgrade Suite Setup
Suite Teardown   Upgrade suite teardown
Test Setup       Upgrade base test setup
Test Teardown    Upgrade base test teardown
Force Tags       T5   Ironhorse   ha   upgrade
Library			 OperatingSystem
Library          keywords/BsnCommon.py
Library			 keywords/Mininet.py
Library		     keywords/Host.py
Library		     keywords/Ixia.py
Library		     keywords_dev/mingtao/T5_longevity.py
Library	         keywords/T5Platform.py
Library	         keywords/T5Parallel.py
Library	         keywords/T5ZTN.py 
Library	         keywords/T5Utilities.py 
Library	         keywords/T5.py
Library          keywords/T5L3.py
Library	         keywords/Controller.py
Library	         keywords/SwitchLight.py
Resource		 testsuites_dev/mingtao/t5_upgrade_ztn_resource.txt 

# document: https://bigswitch.atlassian.net/wiki/display/BSC/T6+Upgrade section: 6.4
# The purpose of this test suite is to verify ztn function with upgrade.
# Test topology:  2 controllers,  2 spines and 6 leaves.
# Configuration:    
# Note: prerequisites:  ONIE installed switch 
#       no support: ONIE install and  ONIE (u-boot) upgrade. 
#                   loader upgrade  
#       support:  loader install, swi upgrade
#       upgrade commit/abort not implemented
# In this Test Suite the following terms will be used:
# - stand-by switch - switch configured on the controller (with MAC address) with no fabric-role specified
# - provisioned switch - switch configured on the controller (with MAC address) with fabric role, forwarding traffic
# - suspended switch - switch connected to fabric but not configured on the controller,
#   or running wrong version of Swith Light, or with incorrect running-config
#
# Typical upgrade check:  configuration  - remain
#                         log files     -  not wiped out
#                         traffic       -  loss based on the test case 
#                         fabric config -  remain
#                         forwarding table - converged if switch need to reload
# 
#####################  review ##################
#Date:  8/26/201
#Attendee:   Jaiprakash, Bala, Srini, Mike, Cliff
#Note:
#   1.  Remove revert keyword from upgrade, since revert is default behavior -    Mingtao to file the JIRA
#   2.  Define phase II switch upgrade failure behavior  -  JP to talk to customer and file JIRA
#   3.  Remove test case:  HAEVENT: T13.5 HA event - master vm event.
#   4.  Remove non ZTN support test cases: 
#   5.  MIS: T101 verify 3 node controller upgrade:   double check and see cluster can form with 3 nodes
#   6.  MIS: T109 upgrade when controller does not have enough space <<<<<<  nothing to do upgrade
#   7.  Define single node upgrade flow -     Mike/Srini  to discuss



* Variable

${short}  1
${medium}  10
${long}   30
${verylong}    120 
${upgradetime}    600 
${image}    bsn@jenkins:/var/lib/jenkins/jobs/bcf_master/lastSuccessful/archive/controller-upgrade-*-SNAPSHOT.pkg
${image1}    bsn@jenkins:/var/lib/jenkins/jobs/bcf_master/lastSuccessful/archive/controller-upgrade-*-SNAPSHOT.pkg
${image2}    bsn@jenkins:/var/lib/jenkins/jobs/bcf_master/lastSuccessful/archive/controller-upgrade-*-SNAPSHOT.pkg
${image3}    bsn@jenkins:/var/lib/jenkins/jobs/bcf_master/lastSuccessful/archive/controller-upgrade-*-SNAPSHOT.pkg 

${qcowimage}   bsn@jenkins:/var/lib/jenkins/jobs/bcf_master/lastSuccessful/archive/controller-bcf-*.qcow2
${bigtapimage}   bsn@10.8.28.6:/home/bsn/controller-upgrade-bigtap-3.0.0-SNAPSHOT.pkg

${config}   scp://root@10.8.28.6:/home/mingtao/config_basic
${h2ip}     20.20.20.24
${h1ip}  	20.20.20.25
${File}     script.log
${vip}      10.8.28.15
 


* Test Case


 

###### dual nodes controller upgrade  
 
IMAGE: T1.1 verify image download and various related show command
	log  get image from external server 
 		copy_pkg_from_server    ${image}   c1	 
 		cli_delete_image
 		
	log  get image from file(file as source not supported)
		cli_copy   scp://${image}    controller-upgrade-SNAPSHOT.pkg
		enable   c1   copy controller-upgrade-SNAPSHOT.pkg image://
		${result}=  cli content   c1
		Should Contain	${result}	 Error: Invalid Use: image:// dest not supported for file source    
    	   	
	log  get image from self controller(scp should work)	
		cli_delete_image		 
		${ip}=   get_node_ip   master	
		bash_scp   	node=master   source=${image}    dest=controller-upgrade-SNAPSHOT.pkg
 		${localimage}=  Catenate	SEPARATOR=	 admin@  ${ip}  	 :controller-upgrade-SNAPSHOT.pkg
		copy_pkg_from_server   ${localimage}    node=c1     passwd=adminadmin
		 		
	log  get image from slow bandwidth (manual)
	log  show image clis
		enable   c1   show image
		enable   c1   show image detail
		enable   c1   show upgrade images 
  			 	
	[Tags] 	full  feature  upgrade_ztn    
	
IMAGE: T1.2 verify only 1 image can be stored in system 
	log  copy image if there is no image in system
		Copy image if no image exist    c1
 		 	   	
	log  get another image from external server 
 		copy_pkg_from_server    ${image1}    c1	 
		${num}  ${image}=	   cli_check_image  
		Should Be Equal As Integers     ${num}    1      	   	
    			 	
	[Tags] 	sanity  feature  upgrade_ztn     

IMAGE: T1.3 verify delete image 
	log  copy image if there is no image in system
		Copy image if no image exist    c1
  	log  delete image 
 		cli_delete_image    
		${num}  ${image}=	   cli_check_image  
		Should Be Equal As Integers     ${num}    -1      	   	
    			 	
	[Tags] 	sanity  feature  upgrade_ztn   


		 
STAGE: T2 verify image stage and various show commands at master & slave
	log  copy image if image is not available		
		${num}  ${_}=	   cli_check_image   c1
		Run Keyword if   ${num} == -1    copy_pkg_from_server    ${image}	 c1
		${num}  ${_}=	   cli_check_image   c2
		Run Keyword if   ${num} == -1    copy_pkg_from_server    ${image}	 c2
						 		
	log  stage image 
		${result}= 	cli_upgrade_stage      c1
		Should be True     ${result} 		
		${result}= 	cli_upgrade_stage      c2
		Should be True     ${result} 		
		
	log  verify related show commands
		enable   c1   show upgrade staged 
		enable   c1   show upgrade staged details 
		enable   c1   show upgrade status 
		enable   c1   show boot partition  
		enable   c1   show boot partition details
		
 	[Tags] 	full  feature  upgrade_ztn    
    
 
UPGRADE: T11.1 Verify upgrade (controller - upgrade, switch - upgrade )   	
 		Verify Dual nodes upgrade 	  ${image1}
		
 	[Tags] 	sanity  feature  upgrade_ztn   
 	
    
UPGRADE: T11.2 Verify upgrade (controller - upgrade, switch - no need) 
	Run Keyword if   '${image1}' != '${image2}' 		Verify Dual nodes upgrade 	  ${image2}
 		
 	[Tags] 	full  feature  upgrade_ztn   
   

UPGRADE: T11.3 Verify upgrade with same image
	Run Keyword if   '${image1}' != '${image3}'		Verify Dual nodes upgrade 	  ${image3}
		
 	[Tags] 	full  feature  upgrade_ztn    

 
UPGRADE: T11.5 upgrade launch suspend
		Verify Dual nodes upgrade     ${image}    suspend    
				
	[Tags] 	full  feature  upgrade_ztn    
   
UPGRADE: T11.6 upgrade launch timeout
		Verify Dual nodes upgrade     ${image}    switch-timeout 900   	
			
	[Tags] 	full  feature  upgrade_ztn    


UPGRADE: T11.8 upgrade launch suspend timeout
		Verify Dual nodes upgrade     ${image}    suspend switch-timeout 900  
		 		
	[Tags] 	sanity  feature  upgrade_ztn     
    

UPGRADE: T11.9 Verify upgrade rollback 
  	log  step 1 - rollback once the upgrade is finished on both nodes 	
 	log  step 2 - check both controller and switch revert back to old images

	[Tags]  full   feature  upgrade_ztn    manual-untested



UPGRADE: T11.10 standby switch behavior during upgrade 
	log  step 0 - move switch to standby  				
 	log  step 1 - upgrade controller 		
	log  step 2 - verify s8 still in suspended state 
	log  step 3 - add the switch back and reboot
	log  step 3 - verify switch connected with correct images
 						      	      
	[Tags] 	full   feature  upgrade_ztn    

UPGRADE: T11.11 suspended switch behavior during upgrade 
	log  step 0 - prepare switch to suspended 				
 	log  step 1 - upgrade controller
	  		      	      
	[Tags] 	fully   feature  upgrade_ztn   manual-untested 

UPGRADE: T11.11 disconneted switch behavior during upgrade 
	log  step 0 - add a nonexisting switch 	
		config   master  switch dummy	
		config   master  mac 70:72:cf:00:00:00 
					
 	log  step 1 - upgrade controller
#		Verify Dual nodes upgrade     ${image}    
		config   master  no switch dummy	
		cli      master  ''
	 
	  		      	      
	[Tags] 	fully   feature  upgrade_ztn   
  

UPGRADE: T11.12 Verify switch partition for different topology
	log  step 1 - verify switch partition for full redundant spine and leaf
	log  step 2 - verify switch partition with single leaf rack
	log  step 3 - verify switch partition with odd number spine
	log  step 4 - verify switch partition with 1 spine

	[Tags] 	fully   feature  upgrade_ztn   manual-untested 
  

UPGRADE: T11.13 upgrade with static ZTN server
	log  step 1 - get the ip address of two controller
		${c1ip}=  get_node_ip  c1 
		${c2ip}=  get_node_ip  c2	
	log  step 2 - add ztn servers to the boot-config 	
		console_bash_switch_add_ztnserver    s1     ${c1ip},${c2ip}
	log  step 3 - upgrade the controllers
		Verify Dual nodes upgrade     ${image} 
 		
	[Tags] 	fully   feature  upgrade_ztn     

UPGRADE: T11.14 upgrade with dhcp ZTN server
	log   config dhcp server

	[Tags] 	fully   feature  upgrade_ztn   manual-untested 

UPGRADE: T11.15 upgrade with not ZTN server configured
	log   covered in test case T11.1
	
	[Tags] 	fully   feature  upgrade_ztn   


UPGRADE: T11.16 HA failover, make config changes, then do upgrade  
	log	 perform HA failover
		cli_cluster_take_leader
	log  add new tenant to the system
		
	log  perform upgrade
	
	[Tags] 	fully   feature  upgrade_ztn   

UPGRADE: T11.7 VIP in upgrade
	T5Platform.rest_configure_virtual_ip   ${vip}
 	${result}=   cli_show_virtual_ip
 	Should Be Equal As Strings  ${result}  ${vip}
	
 	Verify Dual nodes upgrade 	  ${image1}	
 	${result}=   cli_show_virtual_ip
 	Should Be Equal As Strings  ${result}  ${vip}
 	
  	[Tags] 	full    feature  upgrade_ztn   


SYNC: T12.1 Verify switch config in master controller is pushed to swith(event trigger reload) 
	log  step 1 - modify switch related config in controller(NTP, Logging, SNMP)
   		Modify ZTN related config (NTP,SNMP,LOGGING) 
   		sleep  ${long} 	
	log  step 2 - verify switch startup config is changes for controller
		Verify All Switch Running Config  
		 
	log  step 3 - verify switch running config all updated
 		Verify All Switch Startup Config
 		
	log  step 4 - verify switch running config all updated to default
		Default ZTN related config (NTP,SNMP,LOGGING)	 
		Verify All Switch Running Config 
 		Verify All Switch Startup Config				
	[Tags] 	sanity    feature  upgrade_ztn 


SYNC: T12.2 Verify switch config in controller is pushed to switch(through cli reload) 
	log  step 1 - modify switch related config in switch(NTP, Logging, SNMP)		 
	log  step 2 - perform cli reload		 
	log  step 3 - verify switch running config all revert back
	       
	[Tags]  full   feature  upgrade_ztn    

SYNC: T12.3 Verify controller failover with config changes in switch
	log  step 0 - upgrade
	log  step 1 - modify switch related config in controller(NTP, Logging, SNMP)
 	log  step 2 - perform controller failover and cli reload 		
	log  step 3 - verify switch startup config and running config all updated
 		
	[Tags] 	full    manual-untested  feature  upgrade_ztn  
 
SYNC: T12.4 Verify controller upgrade with switch local config changes 
   	log  step 1 - modify switch related config in switch(NTP, Logging, SNMP)
 	log  step 2 - upgrade both controllers
   	log  step 3 - switch will connect and controller/switch config(in controller) preserved
   	log  step 4 - switch will connect and switch local config is not honored(NTP, Logging, SNMP)
    
	[Tags] 	sanity  manual-untested   feature  upgrade_ztn


HAEVENT: T13.1 HA event - standby controller reboot after upgrade
	log  step 1 - upgrade controllers
 	log  step 2 - reboot standby controller
 	
 	[Tags] 	sanity   feature  upgrade_ztn

HAEVENT: T13.2 HA event - active controller reboot after upgrade 
	log  step 1 - upgrade controller
 	log  step 2 - reboot active controller
 	
  	[Tags] 	full   feature  upgrade_ztn
 
HAEVENT: T13.3 HA event - cli failover
	log  step 1 - upgrade controller
 	log  step 2 - perform cli failover
  	[Tags] 	sanity   feature  upgrade_ztn
  	      
HAEVENT: T13.4 HA event - master power off 
	log  step 1 - upgrade controller
 	log  step 2 - perform master power off
    	
  	[Tags] 	full   feature  upgrade_ztn
  	
  	
 
HAEVENT: T13.5 HA event - master vm event (suspend, shutdown, reset, reboot.????)  
	log  step 1 - upgrade controller
 	log  step 2 - perform master vm event
  	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn  skipped
 


EVENT: T14.1 phase 1 switch power off during upgrade with upgrade launch  
 	log  step 1 - upgrade controller
   	log  step 2 - power off phase I switch during phase I 
  	      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
	
	
EVENT: T14.2 phase II switch power off during upgrade with upgrade launch  
 	log  step 1 - upgrade controller
   	log  step 2 - power off phase II switch during phase II 
  	      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
	
 		
EVENT: T14.5 phase 1 switch power off during upgrade with upgrade launch suspend 
 	log  step 1 - upgrade controller
   	log  step 2 - power off phase I switch during phase I 
  	      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
	
	
EVENT: T14.6 phase II switch power off during upgrade with upgrade launch suspend 
 	log  step 1 - upgrade controller
   	log  step 2 - power off phase II switch during phase II 
  	      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
		
	
EVENT: T14.7 new switch join as provisioned switch after upgrade (1 - swi upgrade, 1 - loader install)
	log  step 1 - upgrade controller
	log  setp 2 - connect new switch as provisioned switch
	
  	[Tags] 	full   feature  upgrade_ztn

EVENT: T14.8 new switch join as standby switch after upgrade (1 - swi upgrade, 1 - loader install)
	log  step 1 - upgrade controller
	log  setp 2 - connect new switch as standby switch

  	[Tags] 	full   feature  upgrade_ztn
  	
EVENT: T14.9 switch link up/down during upgrade
	log  step 1 - during upgrade, go to the switch, shut/no shut port 
	log  step 2 - during upgrade, physical remove link
 
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
	
EVENT: T14.10 L2 miss traffic during upgrade
	log  step 1 - during upgrade, send l2 miss traffic
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
 
EVENT: T14.11 L3 arp resolve during upgrade 
	log  step 1 - during upgrade, send arp request from traffic gen
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn

EVENT: T14.12 L3 arp request during upgrade  
	log  step 1 - during upgrade, system need to send arp request
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn

EVENT: T14.13 mac move during upgrade  
	log  step 1 - during upgrade, send same mac source from different port
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn
  	
EVENT: T14.14 config change during upgrade should be blocked 
		${active}=   get_node_name   master
		${standby}=  get_node_name   slave
		@{nodes}=     create list   c1   c2
		Dual node copy image	 ${nodes}    ${image} 
		Dual node stage image    ${nodes}
		${result}=   Dual node launch image   ${nodes}   finish=no	
		 	
	log  step 1 - during upgrade, do configuration change in old active
		sleep    300
		cli    ${active}   ''
		config    ${active}   tenant try
		${content}=  cli content   ${active}
		Should Contain	 ${content}	 Error:
		
	log  step 2 - during upgrade, do configuration change in new active		
		cli    ${standby}   ''
		config    ${standby}   tenant try
		${content}=  cli content   ${standby}
		Should Contain	 ${content}	 Error:
		
		task_finish_check_parallel   ${result['results']}  ${result['result_dict']}
	
 	 
  	[Tags] 	full    feature  upgrade_ztn    run

     
NEGATIVE: T15.1 non-proper image
	log  non bcf image(bigtap image) failed
#		${result}=  copy_pkg_from_server    ${bigtapimage}    soft_error=True 
# 		Should Contain	${result}	 Error: Invalid Use: integrity validation failed: not an image bundle    
	
    log  bcf image without switch bundle
    log  qcow2 image (not upgrade packet)
    	${result}=  copy_pkg_from_server    ${qcowimage}    soft_error=True
 		Should Contain	${result}	 Error: Invalid Use: integrity validation failed: not an image bundle    
     	
	log  corrupted image
    log  timeout during download image 
    log  ctl-c during image download(manual passed)
    	     
  	[Tags] 	full   feature  upgrade_ztn    negative    JIRA_BSC_6258      

NEGATIVE: T15.2 upgrade stage 
	log  copy image is there is none
		Copy image if no image exist	c1	
	log  corrupt the stage partition(not sure how)
	log  terminate the stage in the middle by type no
		cli   c1  ''	
		${before}=  enable   c1   show boot partition 
		cli_upgrade_stage_negative    c1
		cli   c1  ''
		${after}=  enable   c1   show boot partition 	
		Should Be Equal as Strings   ${before}   ${after}	
	log  terminate the stage by hit ctrl c
		cli   c1  ''
		${before}=  enable   c1   show boot partition 
		cli_upgrade_stage_negative   c1   ctrl-c
		cli   c1  ''		
		${after}=  enable   c1   show boot partition 	
		Should Be Equal as Strings   ${before}   ${after}	
	  		
	 
  	[Tags] 	full     feature  upgrade_ztn	negative      
	  
NEGATIVE: T15.3 controller upgrade launch 
 	log  different image for active and standby, launch will be terminated
	log  only issue launch at active, launch will not proceed, and user can terminate
	log  only issue launch at standby, launch will not proceed, user can terminate
    log  send no to terminated launch at active during prompt
    log  send no to terminated lanuch at standby during prompt
    log  hit ctl-c to terminated active upgrade before standby upgrade has began messgge
    log  hit ctl-c to terminated standby upgrade during message wait for upgrader
    log  hit ctl-c to terminated active upgrade before standby disconneted message
    log  hit ctl-c to terminated standby upgrade standby disconneted message    
    log  hit ctl-c to terminated active controller before standby finish phase1
    log  hit ctl-c to terminated active controller before standby finish phase2
       
  	[Tags] 	full  manual-untested   feature  upgrade_ztn    negative
  
NEGATIVE: T15.4 controller upgrade launch suspend
 	log  different image for active and standby, launch will be terminated
	log  only issue launch at active, launch will not proceed, and user can terminate
	log  only issue launch at standby, launch will not proceed, user can terminate
    log  send no to terminated launch at active during prompt
    log  send no to terminated lanuch at standby during prompt
    log  hit ctl-c to terminated active upgrade before standby upgrade has began messgge
    log  hit ctl-c to terminated standby upgrade during message wait for upgrader
    log  hit ctl-c to terminated active upgrade before standby disconneted message
    log  hit ctl-c to terminated standby upgrade standby disconneted message    
    log  hit ctl-c to terminated active controller before standby finish phase1
    log  hit ctl-c to terminated active controller before standby finish phase2
       
  	[Tags] 	full  manual-untested   feature  upgrade_ztn     negative
  	
 
### Miscellaneous

MIS: T100.1 Verify upgrade from no ZTN switch to ZTN switch    
     
  	[Tags] 	full  manual-untested   feature  upgrade_ztn  skipped
	
MIS: T100.2 Verify upgrade from ZTN switch to no ZTN switch   
      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn   skipped
 

MIS: T100.3 Verify upgrade with no ZTN switch (ztn related set remain during upgrade) 
     
  	[Tags] 	full  manual-untested   feature  upgrade_ztn  skipped

MIS: T100.4 Verify controller reboot with no ZTN switch (ztn related set remain during reboot)  
      
  	[Tags] 	full  manual-untested   feature  upgrade_ztn   skipped

MIS: T101 verify 3 node controller upgrade 
	log  can not form controller with more than 2 nodes
	manual passed	
  	[Tags] 	full  manual    feature  upgrade_ztn 

MIS: T102 upgrade 1 controller, build another one, then join the cluster
	manual passed
  	[Tags] 	full  manual     feature  upgrade_ztn 

MIS: T104 unsupported switch platform ????
  	[Tags] 	full  manual-untested   feature  upgrade_ztn   skipped
  	
MIS: T108 upgrade when controller high CPU
	log  upgrade with high cpu	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn    

MIS: T109 upgrade when controller does not have enough space  
	log  upgrade when controller does not have enough space 
  	[Tags] 	full  manual-untested   feature  upgrade_ztn 

  	
MIS: T111 spawn another session to do upgrade during upgrade  
	log   2 seesions copy image the same time
	log   2 seesions stage image the same time
	log   2 session launch image the same time
  	[Tags] 	full  manual-untested   feature  upgrade_ztn 
  	
  	
MIS: T113 non admin user
	log  non admin user
	
  	[Tags] 	full  manual-untested   feature  upgrade_ztn 

  
 

 
 