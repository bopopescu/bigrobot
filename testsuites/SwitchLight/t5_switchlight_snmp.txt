*Settings
Documentation  SNMP Sanity Test Suite
Suite Setup  snmp suite setup
Suite Teardown   base suite teardown 
Test Setup   base test setup
Test Teardown   base test teardown
Force Tags   platform Sanity
Library  keywords/BsnCommon.py
Library  keywords/AppController.py
Library  keywords/BigTap.py
Library  keywords/SwitchLight.py

* Variable
${switchlight_version}  SwitchLight
${snmp_contact}  nw_admin@super_awesome_switch.com
${snmp_location_1}  CS_RACK11_6004
${snmp_location_2}  CS_RACK11_6013    
${oneGlb9_name}  ethernet6
${tenGly2_name}  ethernet45
${fortyGly2_name}  ethernet51


*Test Case
Configure and Verify Configuration via CLI on LB9 and LY2  
    verify config
    [Tags]  snmp  basic    

Verify SNMP OID sysContact  
    verify snmp attribute  s1  sysContact.0  ${snmp_contact}
    [Tags]  snmp  common    

Verify SNMP OID sysLocation 
    verify snmp attribute  s1  sysLocation.0  ${snmp_location_1}
    [Tags]  snmp  common    

Verify SNMP OID sysDescr  
    verify snmp attribute  s1  sysDescr.0  ${switchlight_version}
    [Tags]  snmp  common    

Verify SNMP OID ifDescr of ma1  
    verify snmp attribute  s1  ifDescr.2  ma1
    [Tags]  snmp  common    
 
Verify SNMP OID ifType of ma1  
    verify snmp attribute  s1  ifType.2  ethernetCsmacd
    [Tags]  snmp  common    
    
Verify SNMP OID ifAdminStatus of ma1  
    verify snmp attribute  s1  ifAdminStatus.2  up
    [Tags]  snmp  common  run   
    
Verify SNMP OID ifOperStatus of ma1  
    verify snmp attribute  s1  ifOperStatus.2  up
    [Tags]  snmp  common    
    
Verify SNMP OID ifSpeed of ma1  
    verify snmp attribute  s1  ifSpeed.2  1000000000
    [Tags]  snmp  common    

Verify SNMP OID ifMtu of ma1  
    verify snmp attribute  s1  ifMtu.2  1500
    [Tags]  snmp  common

Verify SNMP OID ifDescr of 1Gig Data Port
    verify snmp attribute  s1  ifDescr.1006  ${oneGlb9_name}
    [Tags]  snmp  1G    
    
Verify SNMP OID ifType of 1Gig Data Port
    verify snmp attribute  s1  ifType.1006  ethernetCsmacd
    [Tags]  snmp  1G
        
Verify SNMP OID ifAdminStatus of 1Gig Data Port
    verify snmp attribute  s1  ifAdminStatus.1006  up
    [Tags]  snmp  1G
        
Verify SNMP OID ifOperStatus of 1Gig Data Port
    verify snmp attribute  s1  ifOperStatus.1006  up
    [Tags]  snmp  1G
        
Verify SNMP OID ifSpeed of 1Gig Data Port
    verify snmp attribute  s1  ifSpeed.1006  1000000000
    [Tags]  snmp  1G
        
Verify SNMP OID ifHighSpeed of 1Gig Data Port
    verify snmp attribute  s1  ifHighSpeed.1006  1000
    [Tags]  snmp  1G
        
Verify SNMP OID ifPhysAddress of 1Gig Data Port 
    ${mac_address1}=  cli show interface macaddress  s1  ${oneGlb9_name} 
    verify snmp attribute  s1  ifPhysAddress.1006  ${mac_address1}
    [Tags]  snmp  1G
        
Verify SNMP OID ifDescr of 10Gig Data Port  
    verify snmp attribute  s1  ifDescr.1045  ${tenGly2_name}
    [Tags]  snmp  10G
        
Verify SNMP OID ifType of 10Gig Data Port  
    verify snmp attribute  s1  ifType.1045  ethernetCsmacd
    [Tags]  snmp  10G
        
Verify SNMP OID ifAdminStatus of 10Gig Data Port  
    verify snmp attribute  s1  ifAdminStatus.1045  up
    [Tags]  snmp  10G
        
Verify SNMP OID ifOperStatus of 10Gig Data Port  
    verify snmp attribute  s1  ifOperStatus.1045  up
    [Tags]  snmp  10G
        
Verify SNMP OID ifSpeed of 10Gig Data Port  
    verify snmp attribute  s1  ifSpeed.1045  4294967295
    [Tags]  snmp  10G
        
Verify SNMP OID ifHighSpeed of 10Gig Data Port  
    verify snmp attribute  s1  ifHighSpeed.1045  10000
    [Tags]  snmp  10G
    
Verify SNMP OID ifPhysAddress of 10Gig Data Port  
    ${mac_address1}=  cli show interface macaddress  s1  ${tenGly2_name} 
    verify snmp attribute  s1  ifPhysAddress.1045  ${mac_address1}
    [Tags]  snmp  10G
    
Verify SNMP OID ifDescr of 40Gig Data Port  
    verify snmp attribute  s1  ifDescr.1051  ${fortyGly2_name}
    [Tags]  snmp  40G
        
Verify SNMP OID ifType of 40Gig Data Port  
    verify snmp attribute  s1  ifType.1051  ethernetCsmacd  
    [Tags]  snmp  40G
        
Verify SNMP OID ifAdminStatus of 40Gig Data Port  
    verify snmp attribute  s1  ifAdminStatus.1051  up
    [Tags]  snmp  40G
        
Verify SNMP OID ifOperStatus 40Gig Data Port  
    verify snmp attribute  s1  ifOperStatus.1051  up
    [Tags]  snmp  40G
        
Verify SNMP OID ifSpeed of 40Gig Data Port  
    verify snmp attribute  s1  ifSpeed.1051  4294967295
    [Tags]  snmp  40G
        
Verify SNMP OID ifHighSpeed of 40Gig Data Port  
    verify snmp attribute  s1  ifHighSpeed.1051  40000
    [Tags]  snmp  40G
        
Verify SNMP OID ifPhysAddress of 40Gig Data Port  
    ${mac_address1}=  cli show interface macaddress  s1  ${fortyGly2_name} 
    verify snmp attribute  s1  ifPhysAddress.1051  ${mac_address1}
    [Tags]  snmp  40G
    
Verify snmpgetnext works as expected 
    verify snmpgetnext
    [Tags]  snmp
        
Verify snmpbulkget works as expected 
    verify snmpbulkget
    [Tags]  snmp
        
Verify snmpbulkwalk works as expected 
    verify snmpbulkwalk
    [Tags]  snmp
        
Verify snmptrap is generated on dataport linkflap
    clear snmpttlog  10.192.66.230
    sleep  10
    cli disable interface  s1  ethernet45
    sleep  60
    ${output}=  return snmptrap output  10.192.66.230  "Link down on interface 1045"
    Should contain  ${output}  Operational state: 2  
    sleep  10
    clear snmpttlog  10.192.66.230
    sleep  10    
    cli enable interface  s1  ethernet45
    sleep  60
    ${output}=  return snmptrap output  10.192.66.230  "Link up on interface 1045"
    Should contain  ${output}  Operational state: 1     
    [Tags]  snmp  jira-pan-741 
         

Modify SNMP Community and Verify SNMP OID sysContact 
    modify community
    [Tags]  snmp
        
Verify no snmp-server disables snmp 
    disable snmp
    [Tags]  snmp
        
Restart process SNMPD and verify SNMP Stats 
    restart snmpd
    [Tags]  snmp
    
* Keywords  
snmp suite setup
    base suite setup
    bash execute command    s1   ofad-ctl autoneg 6        
    cli add snmp keyword   s1   community   ro public       
    cli add snmp keyword   s1   location   ${snmp_location_1}       
    cli add snmp keyword   s1   contact   ${snmp_contact}       
    cli add snmp host   s1   10.192.66.230   traps   public   162   
    cli add snmp host   s1   10.192.66.230   informs   public   162
    cli enable snmp   s1                       
    Sleep   30             

verify config               
    ${snmp_output}=  cli show snmp   s1        
    Should Contain   ${snmp_output}   ${snmp_location_1}        `                                           
    Should Contain   ${snmp_output}   ${snmp_contact}        
    Should Contain   ${snmp_output}   public        
    Should Contain   ${snmp_output}   enabled  
    cli verify portchannel  s1  1       

verify snmp attribute  [Arguments]  ${switch}  ${attribute}  ${expected_value}               
    ${snmp_key} =     snmp cmd   ${switch}   snmpget    public   ${attribute}  
    Should Contain   ${snmp_key}   ${expected_value}

verify snmpgetnext
    ${snmp_key} =   snmp cmd  s1  snmpgetnext  public  ifDescr.1
    Should Contain  ${snmp_key}  ma1

verify snmpbulkget
    ${snmp_key}=  snmp cmd opt   s1  snmpbulkget  -Cr1  public  ifDescr.1
    Should Contain  ${snmp_key}  ma1

verify snmpbulkwalk
    ${snmp_key}=  snmp cmd opt   s1  snmpbulkwalk  -Cr2  public  ifDescr.2
    Should Contain  ${snmp_key}  ma1

modify community
    cli delete snmp keyword  s1  community  ro public
    cli add snmp keyword  s1  community  ro bigswitch
    ${snmp_key}=  snmp cmd  s1  snmpget   bigswitch  sysContact.0
    Should Contain  ${snmp_key}  ${snmp_contact}
    cli delete snmp keyword  s1  community  ro bigswitch
    cli add snmp keyword  s1  community  ro public

disable snmp
    cli disable switch snmp  s1
    Sleep  5
    ${snmp_output} =   cli show snmp  s1
    Should Contain  ${snmp_output}  disabled
    ${snmp_key}=  snmp cmd  s1  snmpget   public  sysContact.0
    Should Be Empty  ${snmp_key}  
    cli enable snmp  s1
    Sleep  5
    ${snmp_output} =   cli show snmp  s1
    Should Contain  ${snmp_output}  enabled
    ${snmp_key}=  snmp cmd  s1  snmpget   public  sysContact.0
    Should Contain  ${snmp_key}  ${snmp_contact}

restart snmpd
    bash restart process  s1   snmpd
    ${snmp_output}=  cli show snmp  s1
    Should Contain  ${snmp_output}  ${snmp_location_1}
    Should Contain  ${snmp_output}  ${snmp_contact}
    Should Contain  ${snmp_output}  public
    ${snmp_key}=  snmp cmd  s1  snmpget  public  sysContact.0
    Should Contain  ${snmp_key}  ${snmp_contact} 

snmp suite teardown  
    cli disable switch snmp   s1            
    cli delete snmp keyword   s1   community   ro public       
    cli delete snmp keyword   s1   location   ${snmp_location_1}  
    cli delete snmp keyword   s1   contact   ${snmp_contact}       
    cli delete snmp host   s1   10.192.66.230   traps   public   162   
    cli delete snmp host   s1   10.192.66.230   informs   public   162       
    base suite teardown      
