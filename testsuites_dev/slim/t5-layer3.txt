* Setting
Documentation   T5 Basic L3 single leaf dual rack Test Suite
Suite Setup     base suite setup
Suite Teardown  base suite teardown
Test Setup      base test setup
Test Teardown   teardown topology
Force Tags      T5 Sanity
Library         keywords/BsnCommon.py
Library         keywords/Mininet.py
Library         keywords_dev/T5.py
Library         keywords_dev/T5Fabric.py
Library         keywords_dev/slim/T5_L3.py
Resource		keywords_dev/t5_singleleaf_resource.txt

* Variable
${tenant1_name}		A
${tenant2_name}		B
${vns_1}			A1
${vns_2}			A2
${vns_3}			B1
${vns1_ip}			10.10.10.1
${vns1_subnet}		24
${vns2_ip}			10.10.11.1
${vns2_subnet}		24
${vns3_ip}			10.10.20.1
${vns3_subnet}		24
${unknown_host}		10.99.99.99
${leaf_name}		leaf0
${leaf0_intf1}		leaf0-eth3
${leaf0_intf2}		leaf0-eth4
${leaf0_intf3}		leaf0-eth5
${host0_ip}			10.10.10.11
${host0_subnet}		24
${host1_ip}			10.10.11.11
${host1_subnet}		24
${host2_ip}			10.10.20.11
${host2_subnet}		24
${gw_mac}			5c:16:c7:01:00:00
${host0_name}		bm0
${host1_name}		bm1
${host2_name}		bm2
${host0_intf}		bm0-eth0
${host1_intf}		bm1-eth0
${host2_intf}		bm2-eth0
${host0_bondif}		bm0-bond0
${host1_bondif}		bm1-bond0
${host2_bondif}		bm2-bond0
${vns1_vlan}		100
${vns2_vlan}		4094
${vns3_vlan}		4091
${ping_count}		10
${host0_mac}		00:00:00:00:00:01
${host1_mac}		00:00:00:00:00:02
${host2_mac}		00:00:00:00:00:03
${dstroute1}		10.111.0.0/16
${dstroute2}		10.112.0.0/16
${dstroute3}		10.113.0.0/16
${dstroute4}		10.114.0.0/16
${nexthopgroup1}	{"ecmp-group-name": "e1"}
${nexthopgroup2}	{"ecmp-group-name": "e2"}
${nexthopgroup3}	{"ip-address": "10.222.1.1"}
${nexthopgroup4}	{"tenant-name": "Z"}
${ecmpgroup1}		e1
${ecmpgroup2}		e2
${nexthop1}			10.10.10.2
${nexthop2}			10.10.10.3
${nexthop3}			10.10.10.4
${nexthop4}			10.10.11.5
${nexthop5}			10.10.11.3
${nexthop6}			10.10.11.4


* Test Case
#Configure topology
#	configure fabric switch 
#	sleep  5

L3 ping bm0 to bm1 single leaf single rack within tenant different VNS
	[Tags]						smoke		skipped	
	configure fabric switch 
	sleep  5		
	REST create tenant  		${tenant1_name}
	REST create vns  			${tenant1_name}		${vns_1}
	REST create vns				${tenant1_name}		${vns_2}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
	REST create vns ip  		${tenant1_name}  	${vns_2}  		${vns2_ip}	  	${vns2_subnet}
	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  -1 
	REST add interface to vns  	${tenant1_name}  	${vns_2}  		${leaf_name} 	${leaf0_intf2} 	-1
	mininet host ipcfg   		${host0_name}		${host0_bondif}	${host0_ip}		${host0_subnet} 
	mininet host ipcfg			${host1_name}		${host1_bondif}	${host1_ip}		${host1_subnet}
	mininet host gw				${host0_name}		${vns1_ip}		${host0_bondif}
	mininet host gw				${host1_name}		${vns2_ip}		${host1_bondif}
	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
	mininet host arp			${host1_name} 		${vns2_ip}		${gw_mac}
	sleep  5
	${loss}=  					mininet l3 ping		${host0_name}	${host1_name} 	
	sleep  						20       
	Should Be True  			${loss} == 0
	${endpoints_cnt}=			rest count endpoints mac
	Should Be True  			${endpoints_cnt} == 2
	REST delete tenant 			${tenant1_name}        
	sleep  						20  
	      
L3 ping bm0 to unreachable host single leaf single rack single tenant across VNS
	[Tags]						skipped
	configure fabric switch 
	sleep  5	
	REST create tenant  		${tenant1_name}
	REST create vns  			${tenant1_name}		${vns_1}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  -1 
	mininet host ipcfg   		${host0_name}		${host0_bondif}	${host0_ip}		${host0_subnet} 
	mininet host gw				${host0_name}		${vns1_ip}		${host0_bondif}
	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
	sleep  5
	${loss}=  					mininet l3 ping		${host0_name}	${unknown_host}	${ping_count}
	sleep  						20    
	Should Be True  			${loss} == 100
	REST delete tenant 			${tenant1_name}        
	sleep  						20  
    
L3 ping bm0 to bm1 single leaf single rack across tenants  
   	[Tags]						smoke				skipped
	configure fabric switch 
	sleep  5   	
	REST create tenant  		${tenant1_name}        
	REST create tenant  		${tenant2_name} 
   	REST create vns				${tenant1_name}		${vns_1}	      
	REST create vns  			${tenant2_name}		${vns_3}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
   	REST create vns ip  		${tenant2_name}  	${vns_3}  		${vns3_ip}	  	${vns3_subnet}
 	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  -1 
   	REST add interface to vns  	${tenant2_name}  	${vns_3}  		${leaf_name} 	${leaf0_intf3} 	-1
   	REST attach tenant routers to system 	${tenant1_name} 
   	REST attach tenant routers to system 	${tenant2_name} 
   	mininet host ipcfg   		${host0_name}		${host0_bondif}	${host0_ip}		${host0_subnet} 
   	mininet host ipcfg			${host2_name}		${host2_bondif}	${host2_ip}		${host2_subnet}
   	mininet host gw				${host0_name}		${vns1_ip}		${host0_bondif}
   	mininet host gw				${host2_name}		${vns3_ip}		${host2_bondif}
   	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
   	mininet host arp			${host2_name} 		${vns3_ip}		${gw_mac}
   	sleep 	 					5
   	${loss}=					mininet l3 ping		${host0_name}	${host1_name}	${ping_count}
	sleep  						20
   	Should Be True  			${loss} == 0
	REST delete tenant			${tenant1_name}   
	REST delete tenant			${tenant2_name}     
   	sleep  						20  
   
L3 ping untagged bm0 to tagged bm1 single leaf single rack within tenant different VNS
	[Tags]						skipped
	configure fabric switch 
	sleep  5	
	REST create tenant  		${tenant1_name}
	REST create vns  			${tenant1_name}		${vns_1}
	REST create vns				${tenant1_name}		${vns_2}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
	REST create vns ip  		${tenant1_name}  	${vns_2}  		${vns2_ip}	  	${vns2_subnet}
	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  -1 
	REST add interface to vns  	${tenant1_name}  	${vns_2}  		${leaf_name} 	${leaf0_intf2}	${vns2_vlan}
	mininet host ipcfg   		${host0_name}		${host0_bondif}	${host0_ip}		${host0_subnet} 
	mininet l3 link tag			${host1_name}		${host1_bondif}	${vns2_vlan}	${host1_ip}		${host1_subnet}
	mininet host gw				${host0_name}		${vns1_ip}		${host0_bondif}
	mininet host tagged gw		${host1_name}		${vns2_ip}		${vns2_vlan}
	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
	mininet host arp			${host1_name} 		${vns2_ip}		${gw_mac}
	sleep 						5
	${loss}=  					mininet l3 ping		${host0_name}	${host1_name}	${ping_count}
	sleep  						20
	Should Be True  			${loss} == 0
	REST delete tenant 			${tenant1_name}        
	mininet l3 link untag		${host1_name}		${host1_bondif}	${vns2_vlan}	${host1_ip}		${host1_subnet}
	sleep  						20  

 
L3 ping tagged bm0 to tagged bm1 single leaf single rack within tenant different VNS
	[Tags]						skipped
	configure fabric switch 
	sleep  5	
	REST create tenant  		${tenant1_name}
	REST create vns  			${tenant1_name}		${vns_1}
	REST create vns				${tenant1_name}		${vns_2}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
	REST create vns ip  		${tenant1_name}  	${vns_2}  		${vns2_ip}	  	${vns2_subnet}
	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  ${vns1_vlan}
	REST add interface to vns  	${tenant1_name}  	${vns_2}  		${leaf_name} 	${leaf0_intf2}	${vns2_vlan}
	mininet l3 link tag			${host0_name}		${host0_bondif}	${vns1_vlan}	${host0_ip}		${host0_subnet}
	mininet l3 link tag			${host1_name}		${host1_bondif}	${vns2_vlan}	${host1_ip}		${host1_subnet}
	mininet host tagged gw		${host0_name}		${vns1_ip}		${vns1_vlan}
	mininet host tagged gw		${host1_name}		${vns2_ip}		${vns2_vlan}
	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
	mininet host arp			${host1_name} 		${vns2_ip}		${gw_mac}
	sleep  						5
	${loss}=  					mininet l3 ping		${host0_name}	${host1_name}	${ping_count}
	Should Be True  			${loss} == 0
	sleep  						20   
	REST delete tenant 			${tenant1_name} 
	mininet l3 link untag		${host0_name}		${host0_bondif}	${vns1_vlan}	${host0_ip}		${host0_subnet}
	mininet l3 link untag		${host1_name}		${host1_bondif}	${vns2_vlan}	${host1_ip}		${host1_subnet}       
	sleep  						20  
   
L3 ping with destination host interface move in the same tenant
	[Tags]						skipped
	configure fabric switch 
	sleep  5	
	REST create tenant  		${tenant1_name}
	REST create vns  			${tenant1_name}		${vns_1}
	REST create vns				${tenant1_name}		${vns_2}
	REST create vns ip  		${tenant1_name}  	${vns_1}  		${vns1_ip}	  	${vns1_subnet}
	REST create vns ip  		${tenant1_name}  	${vns_2}  		${vns2_ip}	  	${vns2_subnet}
	REST add interface to vns  	${tenant1_name}  	${vns_1}  		${leaf_name} 	${leaf0_intf1}  -1 
	REST add interface to vns  	${tenant1_name}  	${vns_2}  		${leaf_name} 	${leaf0_intf2} 	-1
	REST add interface to vns  	${tenant1_name}  	${vns_2}  		${leaf_name} 	${leaf0_intf3} 	-1
	mininet host ipcfg   		${host0_name}		${host0_bondif}	${host0_ip}		${host0_subnet} 
	mininet host ipcfg			${host1_name}		${host1_bondif}	${host1_ip}		${host1_subnet}
	mininet host gw				${host0_name}		${vns1_ip}		${host0_bondif}
	mininet host gw				${host1_name}		${vns2_ip}		${host1_bondif}
	mininet host arp			${host0_name}		${vns1_ip}		${gw_mac}
	mininet host arp			${host1_name} 		${vns2_ip}		${gw_mac}
	sleep  						5
	${loss}=  					mininet l3 ping		${host0_name}	${host1_name} 	
	Should Be True  			${loss} == 100
	sleep 						5
	mininet link down			${host1_name}		${host1_bondif}
	mininet link down			${host1_name}		${host1_intf}
	mininet link down			${host2_name}		${host2_bondif}
	mininet link down			${host2_name}		${host2_intf}	
	mininet host mac config		${host2_name}		${host2_bondif}	${host1_mac}
	mininet host ipcfg			${host2_name}		${host2_bondif}	${host1_ip}		${host1_subnet}
	mininet host gw				${host2_name}		${vns1_ip}		${host2_bondif}
	mininet host arp			${host2_name}		${vns1_ip}		${gw_mac}
	mininet link up				${host2_name}		${host2_intf}	
	mininet link up				${host2_name}		${host2_bondif}	
	sleep						1
	${loss}=  					mininet l3 ping		${host0_name}	${host2_name} 	
	Should Be True  			${loss} == 100
	${endpoints_cnt}=			rest count endpoints mac
	Should Be True  			${endpoints_cnt} == 2
	REST delete tenant 			${tenant1_name}        
	sleep  						20  

L3 ping with nexthop in a ecmp group
	[Tags]							
	configure fabric switch 
	sleep  5	
    REST create tenant              ${tenant1_name}
	REST create vns					${tenant1_name}         ${vns_1}
    REST add ecmp group				${tenant1_name}         ${ecmpgroup1}
    REST add ecmp group				${tenant1_name}         ${ecmpgroup2}
    REST add gw pool nexthop        ${tenant1_name}         ${ecmpgroup1}   ${nexthop1}
    REST add gw pool nexthop        ${tenant1_name}         ${ecmpgroup1}   ${nexthop2}
    REST add gw pool nexthop        ${tenant1_name}         ${ecmpgroup2}   ${nexthop2}
    REST add gw pool nexthop        ${tenant1_name}         ${ecmpgroup2}   ${nexthop3}
    REST add static routes          ${tenant1_name}         ${dstroute1}	${nexthopgroup1}
    REST add static routes          ${tenant1_name}         ${dstroute1}	${nexthopgroup2}
    REST add static routes          ${tenant1_name}         ${dstroute2} 	${nexthopgroup2}
    REST add static routes          ${tenant1_name}         ${dstroute3}	${nexthopgroup3}
    REST add static routes          ${tenant1_name}         ${dstroute4}	${nexthopgroup4}
    
    
    
   
* Keywords
teardown topology
#	remove fabric switch
#	REST delete tenant			${tenant1_name}   
#	REST delete tenant			${tenant2_name}     
		
	
	
	