*** Settings ***
Documentation  		Testing ZTN
Suite Setup  		Base Suite Setup
Suite Teardown   	Base Suite Teardown
Test Setup   		Base Test Setup
Test Teardown  		Base Test Teardown
Library  			keywords/BsnCommon.py
Library  			keywords/T5Platform.py
Library  			keywords/T5Utilities.py
Library				keywords/T5ZTN.py

*** Variables ***
@{supported_installer_platforms}  powerpc-quanta-lb9-r0  powerpc-quanta-ly2-r0
	...  powerpc-dni-7448-r0  powerpc-as6700-32x-r0  powerpc-as5710-54x-r0a
	...  powerpc-as6700-32x-r0b  powerpc-as5710-54x-r0b
@{supported_swi_platforms}  powerpc-quanta-lb9-r0  powerpc-quanta-ly2-r0
	...  powerpc-as6700-32x-r0  powerpc-as5710-54x-r0a  powerpc-dni-7448-r0

*** Test Cases ***
### Basic image check
T1.1. Verify that images are present on all controllers
	Bash Verify SL Images  node=master
	Bash Verify SL Images  node=slave

T1.2. Verify that manifest files are included in SL image bundles
	Bash Verify SL Manifests  node=master
	Bash Verify SL Manifests  node=slave

T1.3. Check supported platforms of SWI and installer
	@{installer_platforms}=  Bash Get Supported Platforms  installer
	@{swi_platforms}=  Bash Get Supported Platforms  swi
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[0]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[1]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[2]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[3]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[4]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[5]
	Should Contain  ${installer_platforms}  @{supported_installer_platforms}[6]
	Should Contain  ${swi_platforms}  @{supported_swi_platforms}[0]
	Should Contain  ${swi_platforms}  @{supported_swi_platforms}[1]
	Should Contain  ${swi_platforms}  @{supported_swi_platforms}[2]
	Should Contain  ${swi_platforms}  @{supported_swi_platforms}[3]
	Should Contain  ${swi_platforms}  @{supported_swi_platforms}[4]


### ZTN Server discovery
T2.1. Verify that switch successfully discovers ZTN server
T2.2. Verify that discovery process succeeds when no NTP servers are available in the network
T2.3. Verify that discovery process succeeds when no DNS servers are available in the network

# Single node
T2.S.1. Verify that switch successfully discovers ZTN server in different L2 network (L3 connectivity)
(single server-address in vendor extensions field available)


### Verify that discovery process continues indefinitely when:
T3.1. no DHCP servers are available in the network - before Switch Light Install
T3.2. no DHCP servers are available in the network - after Switch Light Install
T3.3. no ZTN servers are available - before Switch Light Install
T3.4. no ZTN servers are available - after Switch Light Install
T3.5. management port of the switch is down - before Switch Light Install
T3.6. management port of the switch is down - after Switch Light Install
T3.7. switch's MAC address is not configured on the controller - before Switch Light Install
T3.8. switch's MAC address is not configured on the controller - after Switch Light Install
T3.9. switch finds manifest for its MAC address, but platform type of the switch is not supported
T3.10. Verify that discovery process is restarted and continues indefinitely when all controllers go down during Switch Light Installer image download
T3.11. Verify that discovery process is restarted and continues indefinitely when all controllers go down during SWI image download


### Basic manifest, config and image download
T4.1. Verify that switch successfully downloads manifest file, installer, SWI image and startup config
T4.2. Verify that switch caches last known good ZTN manifest from the active ZTN server
T4.3. Verify that switch uses cached image after reboot and does not download it again (if no image change)
T4.4. Verify that switch uses cached config after reboot and does not download it again (if no config change)
T4.5. Verify that discovery process is restarted when downloaded Switch Light Installer image is corrupted
T4.6. Verify that discovery process is restarted when downloaded SWI image is corrupted
T4.7. Verify that discovery process is restarted when switch reboots during Switch Light Installer image download
T4.8. Verify that discovery process is restarted when switch reboots during SWI image download
T4.9. Verify that discovery process is restarted when downloaded manifest file is corrupted (wrong checksum)
T4.10. Verify that discovery process is restarted when specified image path is invalid
T4.11. Verify following behaviors when switch’s MAC gets deleted during switch boot up 
T4.11.1 - while Installer download - no SWI download
T4.11.2 - while SWI download - switch undefined (suspended)
T4.11.3 - while image startup - switch undefined (suspended)
T4.12. Verify following behaviors when switch’s name is changed during switch boot up 
T4.12.1 - while Installer download - correct SWI download and fabric join
T4.12.2 - while SWI download - switch undefined (suspended)
T4.12.3 - while image startup - switch undefined (suspended)
T4.13. Verify following behaviors when ZTN config is changed during switch boot up 
T4.13.1 - while Installer download - correct SWI download and fabric join
T4.13.2 - while SWI download - switch undefined (suspended)
T4.13.3 - while image startup - switch undefined (suspended)
T4.14. Verify following behaviors when switch mode (stand-by <-> mission) is changed during switch boot up 
T4.14.1 - while Installer download - correct SWI download and fabric join
T4.14.2 - while SWI download - switch undefined (suspended)
T4.14.3 - while image startup - switch undefined (suspended)
T4.15. Check what happens when switch’s flash is full and it is supposed to download new SL image

# Single node
T4.S.1. Verify that executing "failover" command while a switch is downloading an image does not interrupt the download process
T4.S.2. Verify that rebooting controller while a switch is downloading Installer image is restarted after controller is up again
T4.S.3. Verify that rebooting controller while a switch is downloading SWI image is restarted after controller is up again

# Two-nodes cluster
T4.C.1. Verify that discovery process is restarted when controller failover (graceful) happens during Installer image download
T4.C.2. Verify that discovery process is restarted when controller failover (graceful) happens during SWI image download
T4.C.3. Verify that discovery process is restarted when controller failover (reboot) happens during Installer image download
T4.C.4. Verify that discovery process is restarted when controller failover (reboot) happens during SWI image download
T4.C.5. Verify that decommissioning a standby node from the cluster does not interrupt ZTN server activity (switch downloading an image finishes the process successfully)
T4.C.6. Verify that decommissioning the active node from the cluster does not interrupt ZTN server activity in other way than failing over (switch downloading an image restarts the process and downloads from new active controller)


### Switch bring-up
# Bring up out-of-the-box switch
T5.1.1. Verify that switch successfully installs startup config template when no fabric role for the switch is specified (stand-by switch)
T5.1.2. Verify that switch successfully installs startup config template when no fabric role for the switch is specified (stand-by switch) when switch config says “shutdown”
T5.1.3. Verify that switch successfully installs startup config template and flows for given spine switch 
T5.1.4. Verify that switch successfully installs startup config template and no flows for given spine switch when switch config says “shutdown”
T5.1.5. Verify that switch successfully installs startup config template and flows for given leaf switch 
T5.1.6. Verify that switch successfully installs startup config template and no flows for given leaf switch when switch config says “shutdown”

# Reboot active switch
T5.2.1. Verify that switch successfully installs startup config template when no fabric role for the switch is specified (stand-by switch)
T5.2.2. Verify that switch successfully installs startup config template when no fabric role for the switch is specified (stand-by switch) when switch config says “shutdown”
T5.2.3. Verify that switch successfully installs startup config template and flows for given spine switch 
T5.2.4. Verify that switch successfully installs startup config template and no flows for given spine switch when switch config says “shutdown”
T5.2.5. Verify that switch successfully installs startup config template and flows for given leaf switch 
T5.2.6. Verify that switch successfully installs startup config template and no flows for given leaf switch when switch config says “shutdown”


### Regular operations
T6.1. Verify that after ZTN configuration change, new startup-config is available in manifest / ZTN url for each switch
T6.2. Verify that after ZTN configuration change, admin is notified to trigger reload of configuration on the switch, and that after reload configuration on switch gets updated 
T6.3. Change ZTN configuration, do not reload the switch, restore old config (check if reload command on UI is still requested), reload switch - verify that config on switch is correct
T6.4. Change ZTN configuration, reload half of switches, restore old config - verify that all switches need to be reloaded
T6.5. Change startup-config on switch manually, verify that startup-config on switch is synced to the one at the controller after reload
T6.6. Manually change running-config on the switch while switch is connected. Verify that controller is able to notice change and ask the switch to update its configuration and switch is disallowed from the network until config gets updated
T6.7. Manually change running-config on the switch while switch is disconnected. Verify that after reconnecting switch, controller is able to recognize change and ask the switch to update its configuration and switch is disallowed from the network until config gets updated
T6.8. Disconnect all switches from the fabric (ma1 down) then do significant changes in fabric configuration (startup-config template, switch roles) - error should be presented, reconnect the switch - incorrect running config should be noticed by the controller and admin should be notified to take action (reload config on switch)
T6.9. Delete all switches from the controller, reboot all switches (they should keep looking for ZTN server). Copy RC from external source (config://, scp://, file) to running config, watch the fabric come up.


### 


### Miscellaneous
Verify that switch stays in stand-by mode when all controllers go down (until rebooted)
Verify that switch stays in mission mode when all controllers go down (until rebooted)
Verify that controller does platform check for switches, after configuring their MAC address, to see whether they are on the supported platform list
Issue reload command for a switch that is not connected - error should be presented
Issue reboot command for a switch that is not connected - error should be presented

Power down a switch in stand-by mode. When switch is down 1. do global ZTN change, 2. do switch state change - change to mission mode. Boot switch. Verify switch installs updated config and becomes a mission mode switch.
	Shutdown MA1  ${switch}
	Change ZTN config
	Change Switch Mode  ${switch}  mission
	Reboot Switch  ${switch}
	No Shutdown MA1  ${switch}
	Verify State  ${switch}  mission
	Verify ZTN config  ${switch}
