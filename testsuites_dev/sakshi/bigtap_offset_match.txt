*Settings
Documentation  Corsair Offset Match Test Suite
Suite Setup  offset suite setup
#Suite Teardown   offset suite teardown
Test Setup   base test setup
Test Teardown  offset test teardown 
Force Tags   Corsair  BigTap  Sanity  Feature
Library  keywords/BsnCommon.py
Library  keywords/AppController.py
Library  keywords/BigTap.py
Library  keywords/SwitchLight.py
Library  keywords/Ixia.py

### Ixia Ports

* Variable
${switch1_alias}                        qa-corsair-1  #Alias for switch 1
${switch2_alias}                        qa-corsair-2  #Alias for switch 2
${switch1_filter_intf_name}				ethernet1
${switch1_filter_alias} 				ixia-2-9
${switch2_delivery_intf_name} 			ethernet1
${switch2_delivery_alias}				ixia-2-15
${switch1}								00:00:5c:16:c7:1e:f3:95
${switch2}								00:00:5c:16:c7:1c:16:f2


${bigtap_policy_name}					offset-policy


*Test Case
 

### GTPv1 Test Cases


01_Verify offset match with GTP version
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-version": 1, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  offset-match  feature

02_Verify offset match with GTP Protocol Type GTP(value 1)
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"dst-tp-port": 2152, "ether-type": 2048, "gtp-v1-protocol-type": 1, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=3000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  offset-match  feature  
	
03_Verify offset match with GTP Protocol Type GTP'(value 0)
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"dst-tp-port": 2152, "ether-type": 2048, "gtp-v1-protocol-type": 0, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

04_Verify offset match with GTPv1 TEID
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature 
	
05_Verify offset match on GTP TEID and send traffic with VLAN header
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518  ethertype=8100  vlan_id=2048  
    ...     src_mac=00:02:03:04:05:06  dst_mac=00:02:03:04:05:07  protocol=UDP  src_port=8001  dst_port=2152  no_arp=True
    ...     src_ip=100.1.1.1  dst_ip=100.1.1.2  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify false results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
06_Verify offset match with GTPv1 TEID and Protocol UDP 
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "sequence": 1, "dst-tp-port": 2152, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
07_Verify offset match with GTP TEID and Destination Port 2152
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "sequence": 1, "dst-tp-port": 2152, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
08_Verify offset match with GTP TEID and Destination Port 2123
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "sequence": 1, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

	
09_Verify offset match with GTP TEID and source port
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"src-tp-port": 63, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=63  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
10_Verify offset match with GTP TEID and source IP address
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"src-ip-mask": "255.255.255.0", "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "src-ip": "100.1.1.1"}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
11_Verify offset match with GTP TEID and destination IP address
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"dst-ip": "100.1.1.2", "ip-proto": 17, "ether-type": 2048, "gtp-v1-teid": 100, "sequence": 1, "dst-tp-port": 2152, "dst-ip-mask": "255.255.255.0"}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
      
  
12_Verify offset match with GTP TEID and VLAN ID
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "vlan": 100, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  vlan_id=100  ethertype=8100  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  dst_ip=100.1.1.2  no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
		
13_Verify offset match with GTP TEID and GTP version
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "gtp-version": 1, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
14_Verify offset match with GTPv TEID and GTP Protocol Type 0
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-protocol-type": 0, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

15_Verify offset match with GTPv TEID and GTP Protocol Type 1
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-protocol-type": 1, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=3000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
16_Verify offset match with GTP TEID, Protocol Type 0 and GTP Version
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "gtp-v1-protocol-type": 0, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "gtp-version": 1, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

17_Verify offset match with GTP TEID, Protocol Type 1 and GTP Version
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "gtp-v1-protocol-type": 1, "ip-proto": 17, "sequence": 1, "gtp-v1-teid": 100, "gtp-version": 1, "dst-tp-port": 2152}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=3000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
####### GTPv2 

01_Verify offset match with GTP Version
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-version": 2, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4000000000000064 
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
	
02_Verify offset match with GTP TEID without the TEID flag set
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify false results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
03_Verify offset match on GTP TEID with the TEID flag set and with UDP traffic
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

04_Verify offset match on GTP TEID with the TEID flag set and with TCP traffic
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 6, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=TCP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

06_Verify offset match with GTP TEID and VLAN ID 
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "ip-proto": 17, "sequence": 1, "vlan": 100, "gtp-v2-teid": 100, "dst-tp-port": 2123}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518  ethertype=8100  vlan_id=100 
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
07_Verify offset match on GTP TEID and send traffic with VLAN Header
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518  ethertype=8100  vlan_id=100
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
08_Verify offset match with GTP TEID and Protocol UDP
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
09_Verify offset match with GTP TEID and Protocol TCP
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 6, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify false results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
10_Verify offset match with GTP TEID and Destination Port
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature

	
11_Verify offset match with GTP TEID and source port
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"src-tp-port": 8001, "ip-proto": 17, "sequence": 1, "ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
	
12_Verify offset match with GTP TEID and source IP address
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"src-ip-mask": "255.255.255.0", "ip-proto": 17, "sequence": 1, "ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123, "src-ip": "100.1.1.1"}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
13_Verify offset match with GTP TEID and destination IP address
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "ip-proto": 17, "dst-ip": "100.1.1.2", "ether-type": 2048, "gtp-v2-teid": 100, "dst-tp-port": 2123, "dst-ip-mask": "255.255.255.0"}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2123
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4800000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
      
  
##Miscellaneous

01_Verify offset match on sctp
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 1, "ip-proto": 132, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=SCTP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
	[Tags]  feature
	
	
02_Match on src-mac with src-mac-mask set
	
	rest delete policy  admin-view  ${bigtap_policy_name}
	sleep  10
	${return_value}=  rest enable feature  full-match
    Should be true   ${return_value}
    sleep  10         
    rest add policy  admin-view  ${bigtap_policy_name}  forward
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"src-mac-mask": "FF:FF:FF:00:00:00", "src-mac": "00:11:00:00:00:00", "sequence": 1}
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch1_filter_alias}   filter
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch2_delivery_alias}  delivery    
    sleep  10
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	${stream}=             L2 add  name=abc  flow=a->b  src_mac=00:11:00:00:00:00  dst_mac=00:11:00:00:00:22  frame_rate=10000
	...						frame_size=1518  dst_cnt=100  src_cnt=100
	...						dst_mac_step=00:00:00:00:00:00  src_mac_step=00:00:00:00:00:01
    clear stats
    start traffic  ${stream}
    sleep    10 
    verify results  a  b  transmitted_frame_rate  received_frame_rate  
    stop traffic   ${stream}
    sleep                  10
    ${report}=             fetch port stats  stream=${stream}
    verify results  a  b  transmitted_frame_rate  received_frame_rate
   
    [Tags]  feature
	
	
03_Match on dst-mac with dst-mac-mask set
	
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"dst-mac-mask": "FF:FF:FF:00:00:00", "dst-mac": "00:11:00:00:30:00", "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	 ${stream}=             L2 add  name=abc  flow=a->b  src_mac=00:11:00:00:30:22  dst_mac=00:11:00:00:30:00  frame_rate=10000
	...						frame_size=1518  dst_cnt=100  src_cnt=100
	...						dst_mac_step=00:00:00:00:00:01  src_mac_step=00:00:00:00:00:00
    clear stats
    start traffic  ${stream}
    sleep    10 
    verify results  a  b  transmitted_frame_rate  received_frame_rate  
    stop traffic   ${stream}
    sleep                  10
    ${report}=             fetch port stats  stream=${stream}
    verify results  a  b  transmitted_frame_rate  received_frame_rate
   
    [Tags]  feature
	
##### Offset Match Testcases

01_Verify no errors are reported in CLI/Syslog while enabling offset based match via cli command "BigTap offset-match"
	rest delete policy  admin-view  ${bigtap_policy_name}
	sleep  10
	#${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    #Should be true  ${verify_policy1}
    ${return_value}=  rest enable feature  l3-l4-offset-match
    Should be true   ${return_value}       
    [Tags]  feature

02_Verify CLI command "BigTap offset-match ?" does not contain any erroneous strings

03_Verify no errors are reported in CLI/Syslog while disabling offset based match via cli command "no BigTap offset-match"

04_With offset matching enabled, verify basic BigTap policy with "match any" condition is active and installed. Verify flow table in switch. 

	${verify_policy1}=  rest delete policy  admin-view  ${bigtap_policy_name}
	Should be true  ${verify_policy1}
	sleep  10
    rest add policy  admin-view  ${bigtap_policy_name}  forward
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"any-traffic": true, "sequence": 1}
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch1_filter_alias}   filter
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch2_delivery_alias}  delivery    
    sleep  10
    #${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    #Should be true  ${verify_policy1}
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1  
    sleep  5
    ${ethType}=  rest return switch flow  s1  0  eth-type
    Should be equal as integers  ${ethType}  2048    
    ${ipproto}=  rest return switch flow  s1  1  ip-proto
    Should be equal as integers  ${ipproto}  17 
    ${dstport}=  rest return switch flow  s1  2  port
    Should be equal as integers  ${dstport}  2152   
    ${udf}=  rest return switch flow  s1  4  udf4
    Should be equal as integers  ${udf}  100
    sleep  5
    ${ethType}=  rest return switch flow  s2  0  eth-type
    Should be equal as integers  ${ethType}  2048    
    ${ipproto}=  rest return switch flow  s2  1  ip-proto
    Should be equal as integers  ${ipproto}  17 
    ${dstport}=  rest return switch flow  s2  2  port
    Should be equal as integers  ${dstport}  2152   
    ${udf}=  rest return switch flow  s2  4  udf4
    Should be equal as integers  ${udf}  100
    sleep  5
    [Tags]  feature
    
    
 05_Verify basic BigTap policy with "1 match gtp gtp-v1-teid 100" condition is active and installed.
	   
   	rest delete policy  admin-view  ${bigtap_policy_name}
    sleep  5
    rest add policy  admin-view  ${bigtap_policy_name}  forward
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch1_filter_alias}  filter
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch2_delivery_alias}  delivery    
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1  
    sleep  5
    ${ethType}=  rest return switch flow  s1  0  eth-type
    Should be equal as integers  ${ethType}  2048    
    ${ipproto}=  rest return switch flow  s1  1  ip-proto
    Should be equal as integers  ${ipproto}  17 
    ${dstport}=  rest return switch flow  s1  2  port
    Should be equal as integers  ${dstport}  2152   
    ${udf}=  rest return switch flow  s1  4  udf4
    Should be equal as integers  ${udf}  100
    ${ethType}=  rest return switch flow  s2  0  eth-type
    Should be equal as integers  ${ethType}  2048    
    ${ipproto}=  rest return switch flow  s2  1  ip-proto
    Should be equal as integers  ${ipproto}  17 
    ${dstport}=  rest return switch flow  s2  2  port
    Should be equal as integers  ${dstport}  2152   
    ${udf}=  rest return switch flow  s2  4  udf4
    Should be equal as integers  ${udf}  100
    [Tags]  feature

06_With TC5 config, change action from forward to inactive. Verify policy is inactive and flows are deleted from both Switches
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    rest add policy action  admin-view  ${bigtap_policy_name}  inactive
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  0 
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  0
    sleep  10    
    [Tags]  feature

07_With TC6 config, change action from inactive to forward. Verify policy is active and installed. Verify flow table on both switch

	${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  0
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  0 
    sleep  10
	${result}=  rest add policy action  admin-view  ${bigtap_policy_name}  forward
	Should be true  ${result}   
    sleep  15
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  10
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1 
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1    
    [Tags]  feature

08_With TC5 config, change action from forward to rate-measure. Verify policy is installed and flows are deleted only from SW 2

	rest add policy action  admin-view  ${bigtap_policy_name}  rate-measure
	sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  0   
    sleep  10 
    [Tags]  feature

09_With TC8 config, change action from rate-measure to forward. Verify policy is active and installed. Verify flow table on both switches
	
	rest add policy action  admin-view  ${bigtap_policy_name}  forward
	sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1
    sleep  10    
    [Tags]  feature
    
10_With TC5 config, change match condition (add second match condition, then delete first match condition). Verify updated flows are installed on both switches.

	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    rest add policy match  admin-view  ${bigtap_policy_name}  2  {"ether-type": 2048, "gtp-v1-protocol-type": 1, "ip-proto": 17, "sequence": 2, "gtp-v1-teid": 100, "gtp-version": 1, "dst-tp-port": 2152}   
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  2
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  2 
    rest delete policy match  admin-view  ${bigtap_policy_name}  1  
    sleep  5    
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1 
    sleep  10
    [Tags]  feature

11_With TC5 config, change match condition (first delete existing match condition, then add second match condition). Verify updated flows are installed on both switches.
	
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    rest delete policy match  admin-view  ${bigtap_policy_name}  2  
    sleep  5   
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  0
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  0  
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1 
    sleep  10 
    [Tags]  feature
    

12_With policy installed (TC5 Configuration), send matching traffic. Verify traffic is forwarded to delivery ports

	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=2000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
    sleep  10
	[Tags]  feature

13_With policy installed, send matching traffic. Verify traffic statistics are reported correctly for offset match in "show bigtap policy <policy_name>"

	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     	src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     	src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...			no_arp=True  payload=2000000000000064
    clear stats
    start traffic  ${stream} 
    sleep          30
    ${filter_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/filter-interface
 	${value}=  Convert To Integer  ${filter_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${tx_value}=  verify dict key  ${report}  a  transmitted_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${tx_value}  rangev=20
 	Should be True  ${return_value}
    ${delivery_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/delivery-interface
 	${value}=  Convert To Integer  ${delivery_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${rx_value}=  verify dict key  ${report}  b  received_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${rx_value}  rangev=20
 	Should be True  ${return_value} 
    stop traffic  ${stream}
    
    [Tags]  feature

14_With policy installed, send matching traffic. Verify traffic statistics are reported correctly in "show bigtap policy <policy_name> delivery-interfaces"

	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     	src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     	src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...			no_arp=True  payload=2000000000000064
    clear stats
    start traffic  ${stream} 
    sleep          35
    ${delivery_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/delivery-interface
 	${value}=  Convert To Integer  ${delivery_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${rx_value}=  verify dict key  ${report}  b  received_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${rx_value}  rangev=20
 	Should be True  ${return_value} 
    stop traffic  ${stream}
 	[Tags]  feature

15_With policy installed, send matching traffic. Verify traffic statistics are reported correctly in "show bigtap policy <policy_name> filter-interfaces"

	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     	src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     	src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...			no_arp=True  payload=2000000000000064
    clear stats
    start traffic  ${stream} 
    sleep          35
    ${filter_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/filter-interface
 	${value}=  Convert To Integer  ${filter_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${tx_value}=  verify dict key  ${report}  a  transmitted_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${tx_value}  rangev=20
 	Should be True  ${return_value}
    stop traffic  ${stream}
 	[Tags]  feature

16_With policy installed. Verify CLI O/P for "show bigtap policy-flow <policy name> "
	 
	${switch1_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]?select=flow-info
     
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][0]['flow'][0]['flow-mod']['match-field'][0]['eth-type']}  2048 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][0]['flow'][0]['flow-mod']['match-field'][1]['ip-proto']}  17 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][0]['flow'][0]['flow-mod']['match-field'][2]['port']}  2152 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][0]['flow'][0]['flow-mod']['match-field'][4]['udf4']}  100
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][0]['flow'][0]['flow-mod']['instruction'][0]['action'][0]['max-length']}  65535
 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][1]['flow'][0]['flow-mod']['match-field'][0]['eth-type']}  2048 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][1]['flow'][0]['flow-mod']['match-field'][1]['ip-proto']}  17 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][1]['flow'][0]['flow-mod']['match-field'][2]['port']}  2152 
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][1]['flow'][0]['flow-mod']['match-field'][4]['udf4']}  100
     Should be equal as integers   ${switch1_dictionary[0]['flow-info'][1]['flow'][0]['flow-mod']['instruction'][0]['action'][0]['max-length']}  65535
     
	 [Tags]  feature

17_With policy installed. Verify CLI O/P for "show bigtap policy <policy name> optimized match"

	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    ${count}=  rest_show_policy_optimize  ${bigtap_policy_name}  
	Should be equal as integers  ${count}  1
 	[Tags]  feature

18_Verify CLI "show running-config"

    ${command_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/interface-config
    # Verify Filter Interface
    Should be equal as strings   ${command_dictionary[0]['interface']}  ${switch2_delivery_intf_name}
    Should be equal as strings   ${command_dictionary[0]['name']}  ${switch2_delivery_alias}
    Should be equal as strings   ${command_dictionary[0]['role']}  delivery
    # Verify Delivery Interface
    Should be equal as strings   ${command_dictionary[1]['interface']}  ${switch1_filter_intf_name}
    Should be equal as strings   ${command_dictionary[1]['name']}  ${switch1_filter_alias}
    Should be equal as strings   ${command_dictionary[1]['role']}  filter
    
    ${command_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view?config=true
    #Should be equal as strings   ${command_dictionary[0]['delivery-interface-group'][0]['delivery-group'][0]['name']}  ${switch2_delivery_alias}
    #Should be equal as strings   ${command_dictionary[0]['filter-interface-group'][0]['filter-group'][0]['name']}  ${switch1_filter_alias}
    Should be equal as strings   ${command_dictionary[0]['policy'][0]['action']}  forward
    Should be equal as strings   ${command_dictionary[0]['policy'][0]['delivery-group'][0]['name']}  ${switch2_delivery_alias}
    Should be equal as strings   ${command_dictionary[0]['policy'][0]['filter-group'][0]['name']}  ${switch1_filter_alias}
    Should be equal as strings   ${command_dictionary[0]['policy'][0]['name']}  ${bigtap_policy_name}
    Should be equal as integers   ${command_dictionary[0]['policy'][0]['rule'][0]['dst-tp-port']}  2152
    Should be equal as integers   ${command_dictionary[0]['policy'][0]['rule'][0]['ether-type']}   2048
    Should be equal as integers   ${command_dictionary[0]['policy'][0]['rule'][0]['gtp-v1-teid']}  100
    Should be equal as integers   ${command_dictionary[0]['policy'][0]['rule'][0]['ip-proto']}   17
    Should be equal as integers   ${command_dictionary[0]['policy'][0]['rule'][0]['sequence']}  1
    [Tags]  feature	

19_Delete and re-add policy and verify flows get deleted and re-installed.

	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
	rest delete policy  admin-view  ${bigtap_policy_name}
    sleep  10    
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  0
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  0   
    rest add policy  admin-view  ${bigtap_policy_name}  forward
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch1_filter_alias}  filter
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch2_delivery_alias}  delivery
  	sleep  10       
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1    
    sleep  10    
    [Tags]  feature
	

20_With policy installed, go from l3-l4-offset mode to l3-l4 mode. Verify CLI disallows
 
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest enable feature  l3-l4
    Should not be true   ${return_value} 
    sleep  10     
    [Tags]  feature
	

21_With policy installed, go from l3-l4-offset mode to full-match mode. Verify CLI disallows
     
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest enable feature  full-match
    Should not be true   ${return_value}
    sleep  10         
    [Tags]  feature

22_With policy installed, enable overlap mode. Verify no affect on BigTap policy
     
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest enable feature  overlap
    Should be true   ${return_value} 
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1
    sleep  10     
    [Tags]  feature

23_With policy installed, disable overlap mode. Verify no affect on BigTap policy
      
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest disable feature  overlap
    Should be true   ${return_value}
    sleep  5 
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${flow_count}=  rest show switch flow  s1
    Should be equal as integers  ${flow_count}  1
    ${flow_count}=  rest show switch flow  s2
    Should be equal as integers  ${flow_count}  1 
    sleep  5     
    [Tags]  feature

24_With policy installed, enable inport-masking. Verify no affect on BigTap policy

	     
   ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest enable feature  inport-mask 
    Should be true   ${return_value}
    sleep  5 
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5      
    [Tags]  feature

25_With policy installed, disable inport-masking. Verify no affect on BigTap policy

    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
    ${return_value}=  rest disable feature  inport-mask 
    Should be true   ${return_value}
    sleep  5 
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1} 
    sleep  5
    [Tags]  feature

26_With policy installed, send non-matching traffic. Verify traffic is dropped at ingress ports
	
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  5
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"sequence": 2, "gtp-v2-teid": 100, "dst-tp-port": 2123, "ip-proto": 17, "ether-type": 2048}
    sleep  5
    ${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
    sleep  10
    ${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518
    ...     src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...		no_arp=True  payload=4000000000000064
    clear stats    
    start traffic  ${stream}
    sleep  10
    verify false results  a  b  transmitted_frame_rate  received_frame_rate    
    stop traffic  ${stream}
    [Tags]  feature

27_With policy installed and match on GTP TEID, send packet with GTP header and bad CRC
	
	rest add policy match  admin-view  ${bigtap_policy_name}  1  {"gtp-v1-teid": 100, "ether-type": 2048, "dst-tp-port": 2152, "ip-proto": 17, "sequence": 1}
    sleep  5
	${verify_policy1}=  rest verify bigtap policy  ${bigtap_policy_name}  num_filter_intf=1  num_delivery_intf=1
    Should be true  ${verify_policy1}
	${stream}=  L3 add  name=gtp_teid  flow=a->b  frame_rate=10000  frame_size=1518  crc=True
    ...     	src_mac=00:01:02:03:04:01  dst_mac=00:01:02:03:04:02  protocol=UDP  src_port=8001  dst_port=2152
    ...     	src_ip=100.1.1.1  src_gw=100.1.1.2  dst_ip=100.1.1.2  dst_gw=100.1.1.1  
    ...			no_arp=True  payload=2000000000000064
    clear stats
    start traffic  ${stream} 
    sleep          10
    ${filter_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/filter-interface
 	${value}=  Convert To Integer  ${filter_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${tx_value}=  verify dict key  ${report}  a  transmitted_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${tx_value}  rangev=20
 	Should be True  ${return_value}
    ${delivery_dictionary}=  rest return dictionary from get  /api/v1/data/controller/applications/bigtap/view/policy[name="offset-policy"]/delivery-interface
 	${value}=  Convert To Integer  ${delivery_dictionary[0]['packet-rate-60']}  
 	${report}=  fetch port stats
 	${rx_value}=  verify dict key  ${report}  b  received_frame_rate
 	${return_value}=  ixia verify traffic rate  ${value}  ${rx_value}  rangev=20
 	Should be True  ${return_value}
    stop traffic  ${stream}
 	[Tags]  feature

	
* Keyword

offset suite setup
    base suite setup
    ${return_value}=  rest enable feature  l3-l4-offset-match
    Should be true   ${return_value}
    rest add switch alias  s1  ${switch1_alias}
    rest add switch alias  s2  ${switch2_alias}
    rest add interface role  s1  ${switch1_filter_intf_name}  filter    intf_nickname=${switch1_filter_alias} 
    rest add interface role  s2  ${switch2_delivery_intf_name}    delivery  intf_nickname=${switch2_delivery_alias}
    rest add policy  admin-view  ${bigtap_policy_name}  forward
    rest add policy match  admin-view  ${bigtap_policy_name}  1  {"any-traffic": true, "sequence": 1}
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch1_filter_alias}   filter
    rest add policy interface  admin-view  ${bigtap_policy_name}  ${switch2_delivery_alias}  delivery
    sleep  30


verify results   [Arguments]  ${send_port}  ${recv_port}  ${transmitted_frames}  ${received_valid_frames}
    Sleep  5
    ${report}=  fetch port stats
    ${tx_value}=  verify dict key  ${report}  ${send_port}  ${transmitted_frames}
    ${rx_value}=  verify dict key  ${report}  ${recv_port}  ${received_valid_frames}
    ${in_range}=  ixia verify traffic rate  ${tx_value}  ${rx_value}
    Should be true  ${in_range}
    
verify false results  [Arguments]  ${send_port}  ${recv_port}  ${transmitted_frames}  ${received_valid_frames}
    Sleep  5
    ${report}=  fetch port stats
    ${tx_value}=  verify dict key  ${report}  ${send_port}  ${transmitted_frames}
    ${rx_value}=  verify dict key  ${report}  ${recv_port}  ${received_valid_frames}
    ${in_range}=  ixia verify traffic rate  ${tx_value}  ${rx_value}
    Should not be true  ${in_range}

offset test teardown
	delete traffic

offset suite teardown
	REST delete policy  admin-view  ${bigtap_policy_name}
    ${return_value}=  rest enable feature  full-match
    Should be true   ${return_value}	
	rest delete interface role  s1  ${switch1_filter_intf_name}       	filter 
    rest delete interface role  s2  ${switch2_delivery_intf_name}       delivery              
    rest delete interface  s1  ${switch1_filter_intf_name}          
    rest delete interface  s2  ${switch2_delivery_intf_name} 
    rest delete switch alias  s1
    rest delete switch  s1
    rest delete switch alias  s2
    rest delete switch  s2
    base suite teardown
