*Settings
Documentation  Controller HA Test Suite
Suite Setup  ha suite setup
Suite Teardown   ha suite teardown
Test Setup   base test setup
Test Teardown   base test teardown
Force Tags   HA Scale
Library   keywords/BsnCommon.py
Library   keywords_dev/animesh/BsnCommonConfig.py
Library  keywords_dev/animesh/BsnCommonShow.py
Library  keywords_dev/animesh/BsnSwitchCommon.py
Library   keywords_dev/animesh/BigTapCommonShow.py
Library   keywords_dev/animesh/BigTapCommonConfig.py

* Variable
${switch1_ip}  10.192.75.7
${switch1_alias}  LB7
${switch2_ip}  10.192.75.215
${switch2_alias}  LB11
${switch3_ip}  10.192.75.214
${switch3_alias}  LY4
${switchlight_version}  SwitchLight 2.0.0-beta1
${sw1_f1}  ethernet5
${sw1_f1nick}  LB7-F1-DL206-D1
${sw1_f2}  ethernet6
${sw1_f2nick}  LB7-F2-DL206-D2
${sw1_f3}  ethernet7
${sw1_f3nick}  LB7-F3-DL206-D3
${sw1_f4}  ethernet8
${sw1_f4nick}  LB7-F4-DL206-D4
${sw2_f1}  ethernet5
${sw2_f1nick}  LB11-F1-AR4-D1
${sw2_f2}  ethernet6
${sw2_f2nick}  LB11-F2-AR4-D2
${sw2_f3}  ethernet7
${sw2_f3nick}  LB11-F3-AR4-D3
${sw2_f4}  ethernet8
${sw2_f4nick}  LB11-F4-AR4-D4
${sw3_d1}  ethernet1
${sw3_d1nick}  LY4-LB81-ET9
${sw3_d2}  ethernet3
${sw3_d2nick}  LY4-LB82-ET9
${sw3_s1}  ethernet37
${sw3_s1nick}  S5-LY4-AR4_E3-PRE
${sw3_s2}  ethernet38
${sw3_s2nick}  S5-LY4-AR4_E4-POST
${filter}  filter
${delivery}  delivery
${service}  service


*Test Case
verify configuration is successful
	verify config

Verify CLI 'show ntp' 
	verify ntpconfig

Verify CLI 'show syslog' 
	verify syslogconfig

Flap eth0 on Master Controller
	flap eth0  Master

Restart Process Floodlight on Master Controller: 
	restart floodlight  Master

Restart Process keepalived on Master Controller: 
	restart keepalived  Master

Restart Process snmpd on Master Controller: 
	restart snmpd  Master

Restart Process rsyslogd on Master Controller: 
	restart rsyslogd  Master
	
Restart Process ntpd on Master Controller: 
	restart ntpd  Master

Restart Process Cassandra on Master Controller: 
	restart cassandra  Master

Flap eth0 on Slave Controller
	flap eth0  Slave

Restart Process Floodlight on Slave Controller: 
	restart floodlight  Slave

Restart Process keepalived on Slave Controller: 
	restart keepalived  Slave

Restart Process snmpd on Slave Controller: 
	restart snmpd  Slave

Restart Process rsyslogd on Slave Controller: 
	restart rsyslogd  Slave
	
Restart Process ntpd on Slave Controller: 
	restart ntpd  Slave

Restart Process Cassandra on Slave Controller: 
	restart cassandra  Slave

Execute HA Failover and verify BigTap Policies
	ha failover

* Keywords  
ha suite setup
	# Assign Alias to switch
	${switchDict}=  REST show switch
	${dpid1}=  return switch dpid  ${switchDict}  ${switch1_ip}
	REST set switch alias  ${dpid1}  ${switch1_alias}
	${dpid2}=  return switch dpid  ${switchDict}  ${switch2_ip}
	REST set switch alias  ${dpid2}  ${switch2_alias}
	${dpid3}=  return switch dpid  ${switchDict}  ${switch3_ip}
	REST set switch alias  ${dpid3}  ${switch3_alias}
	# Configure Filter Interfaces
	REST bigtap setup interface  intf_name=${sw1_f1}  intf_type=${filter}  intf_nickname=${sw1_f1nick}  sw_dpid=${dpid1}
	REST bigtap setup interface  intf_name=${sw1_f2}  intf_type=${filter}  intf_nickname=${sw1_f1nick}  sw_dpid=${dpid1}
	REST bigtap setup interface  intf_name=${sw1_f3}  intf_type=${filter}  intf_nickname=${sw1_f1nick}  sw_dpid=${dpid1}
	REST bigtap setup interface  intf_name=${sw1_f4}  intf_type=${filter}  intf_nickname=${sw1_f1nick}  sw_dpid=${dpid1}
	REST bigtap setup interface  intf_name=${sw2_f1}  intf_type=${filter}  intf_nickname=${sw2_f1nick}  sw_dpid=${dpid2}
	REST bigtap setup interface  intf_name=${sw2_f2}  intf_type=${filter}  intf_nickname=${sw2_f2nick}  sw_dpid=${dpid2}
	REST bigtap setup interface  intf_name=${sw2_f3}  intf_type=${filter}  intf_nickname=${sw2_f3nick}  sw_dpid=${dpid2}
	REST bigtap setup interface  intf_name=${sw2_f4}  intf_type=${filter}  intf_nickname=${sw2_f4nick}  sw_dpid=${dpid2}
	# Configure Delivery Interfaces
	REST bigtap setup interface  intf_name=${sw3_d1}  intf_type=${delivery}  intf_nickname=${sw3_d1nick}  sw_dpid=${dpid3}
	REST bigtap setup interface  intf_name=${sw3_d2}  intf_type=${delivery}  intf_nickname=${sw3_d2nick}  sw_dpid=${dpid3}
	# Configure Service Interfaces
	REST bigtap setup interface  intf_name=${sw3_s1}  intf_type=${service}  intf_nickname=${sw3_s1nick}  sw_dpid=${dpid3}
	REST bigtap setup interface  intf_name=${sw3_s2}  intf_type=${service}  intf_nickname=${sw3_s2nick}  sw_dpid=${dpid3}
	# Configure BigTap Service
	REST bigtap add service  S5-LY4  ${sw3_s1nick}  ${sw3_s2nick}
	Sleep  10
	#Configure BigTap Policy
	REST bigtap add policy  admin-view  P1  forward
	REST bigtap add policy match  admin-view  P1  1  {"ether-type": 2048, "dst-tp-port": 80, "ip-proto": 6, "sequence": 1}
	REST bigtap add policy interface  admin-view  P1  ${sw1_f1nick}  ${filter}
	REST bigtap add policy interface  admin-view  P1  ${sw2_f1nick}  ${filter}	
	REST bigtap add policy interface  admin-view  P1  ${sw3_d1nick}  ${delivery}
	REST bigtap add policy  admin-view  ZP2  forward
	REST bigtap add policy match  admin-view  ZP2  1  {"ether-type": 2048, "src-tp-port": 1234, "ip-proto": 6, "sequence": 1}
	REST bigtap add policy interface  admin-view  ZP2  ${sw1_f1nick}  ${filter}
	REST bigtap add policy interface  admin-view  ZP2  ${sw2_f1nick}  ${filter}	
	REST bigtap add policy interface  admin-view  ZP2  ${sw3_d2nick}  ${delivery}
	REST bigtap add policy  admin-view  P3  forward
	REST bigtap add policy match  admin-view  P3  1  {"src-ip-mask": "255.255.255.252", "sequence": 1, "src-ip": "100.1.1.1", "ip-proto": 132, "ether-type": 2048}
	REST bigtap add policy interface  admin-view  P3  ${sw1_f2nick}  ${filter}
	REST bigtap add policy interface  admin-view  P3  ${sw2_f2nick}  ${filter}	
	REST bigtap add policy interface  admin-view  P3  ${sw3_d1nick}  ${delivery}
	REST bigtap add policy  admin-view  ZP4  forward
	REST bigtap add policy match  admin-view  ZP4  1  {"ether-type": 2048, "sequence": 1, "dst-ip-mask": "255.255.255.252", "ip-proto": 132, "dst-ip": "101.1.1.1"}
	REST bigtap add policy interface  admin-view  ZP4  ${sw1_f2nick}  ${filter}
	REST bigtap add policy interface  admin-view  ZP4  ${sw2_f2nick}  ${filter}	
	REST bigtap add policy interface  admin-view  ZP4  ${sw3_d2nick}  ${delivery}
	
	#Configure NTP and SYSLOG
	Run Keyword And Ignore Error  rest delete ntp  0.bigswitch.pool.ntp.org
	Run Keyword And Ignore Error  rest delete syslog  10.192.66.230  0
	rest configure ntp  0.debian.pool.ntp.org
	rest configure syslog  10.192.66.230  0
	Sleep  30

verify config
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

verify ntpconfig
	${ntpContent}=  rest show ntp
	${ntpState}=  return switch dpid  ${ntpContent}  enabled
	${ntpServer}=  return switch dpid  ${ntpContent}  server
	Should Be Equal As Strings  ${ntpServer}  0.debian.pool.ntp.org
	Should Be True  ${ntpState}

verify syslogconfig
	${syslogContent}=  rest show syslog
	${syslogState}=  return switch dpid  ${syslogContent}  logging-enabled
	${syslogServer}=  return switch dpid  ${syslogContent}  logging-server
	${syslogLevel}=  return switch dpid  ${syslogContent}  logging-level
	Should Be True  ${syslogState}
	Should Be Equal As Strings  ${syslogServer}  10.192.66.230
	Should Be Equal As Integers  ${syslogLevel}  0

flap eth0
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	flap eth0 controller  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

restart floodlight 
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  floodlight  ${controllerRole}
	Sleep  30
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

restart keepalived
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  keepalived  ${controllerRole}
	Sleep  30
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

restart snmpd
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  snmpd  ${controllerRole}
	Sleep  30
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
    
restart rsyslogd
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  rsyslogd  ${controllerRole}
	Sleep  30
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
    
restart ntpd
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  ntpd  ${controllerRole}
	Sleep  30
	${ip_address_list}=  return master slave ip address
	${ntp_op}=  execute controller command return output  ntpdc -p  ${controllerRole}
	${ip_address}=  return switch dpid  ${ip_address_list}  ${controllerRole}
	Should Contain  ${ntp_op}  ${ip_address}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
 
restart cassandra
    [Arguments]  ${controllerRole}
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	restart process controller  cassandra  ${controllerRole}
	Sleep  30
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

ha failover
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2
	rest execute ha failover
	Sleep  120
    REST show bigtap policy  P1  2  1
    REST show bigtap policy  ZP2  2  1
    REST show bigtap policy  P3  2  1
    REST show bigtap policy  ZP4  2  1
    REST show bigtap policy  _ZP2_o_P1  2  2
    REST show bigtap policy  _ZP4_o_P3  2  2

ha suite teardown
    REST bigtap delete policy  admin-view  P1
    REST bigtap delete policy  admin-view  ZP2
    REST bigtap delete policy  admin-view  P3
    REST bigtap delete policy  admin-view  ZP4
    REST bigtap delete service  S5-LY4
