* Setting
Documentation   BigTap Test Suite
Suite Setup     base suite setup
Suite Teardown  base suite teardown
Test Setup      base test setup
Test Teardown   base test teardown
Force Tags      BigTap Sanity
Library         keywords_dev/Common.py
Library         keywords/BsnCommon.py 
Library         keywords_dev/BigTapCommonConfig.py 
Library         keywords_dev/BigTapCommonShow.py 



* Variable
${c1}  10.192.105.1
${c2}  10.192.105.2
 



* Test Case
#Verify all the common show cmd
#	show command
#	[Tags]  skip

Bigtap Prepare topology
	Bigtap Setup role
	[Tags]  skipped

Test IPv4 Address Group
 	bigtap_clean_up             policy
 	bigtap_clean_up             address-group
	Config IPv4 Address Group	IPV4
	Config bigtap policy        IPv4_ADD   S203-50   S203-52
	sleep_now                   short
	REST bigtap add policy match       admin-view  IPv4_ADD   10   {"sequence": 10, "src-ip-list": "IPV4", "ether-type": 2048} 
	REST bigtap add policy match       admin-view  IPv4_ADD   20   {"sequence": 20, "dst-ip-list": "IPV4", "ether-type": 2048} 	
	REST bigtap add policy match       admin-view  IPv4_ADD   30   {"sequence": 30, "dst-ip-list": "IPV4", "src-ip-list": "IPV4","ether-type": 2048}  negative
	REST bigtap add policy match       admin-view  IPv4_ADD   40   {"sequence": 40, "ether-type": 2048, "dst-ip-mask": "255.255.255.0", "src-ip-list": "IPV4", "dst-ip": "10.10.10.0"}  
	REST bigtap add policy match       admin-view  IPv4_ADD   50   {"sequence": 50, "ether-type": 2048, "src-ip-mask": "255.255.255.0", "dst-ip-list": "IPV4", "src-ip": "10.10.10.0"}  	
	sleep_now                   short	
	Bigtap Verify policy        IPv4_ADD   1   1  S203      7
    REST delete policy          admin-view  IPv4_ADD 
	
	[Tags] 	sanity  skipped
	
Test IPv6 Address Group    
  	bigtap_clean_up             policy
 	bigtap_clean_up             address-group    
 	Config IPv6 Address Group   IPV6
	Config bigtap policy        IPv6_ADD   S203-50   S203-52
	sleep_now                   short
	REST bigtap add policy match       admin-view  IPv6_ADD   10   {"sequence": 10, "src-ip-list": "IPV6", "ether-type": 34525} 
	REST bigtap add policy match       admin-view  IPv6_ADD   20   {"sequence": 20, "dst-ip-list": "IPV6", "ether-type": 34525} 	
	REST bigtap add policy match       admin-view  IPv6_ADD   30   {"sequence": 30, "dst-ip-list": "IPV6", "src-ip-list": "IPV6","ether-type": 34525}  negative
	REST bigtap add policy match       admin-view  IPv6_ADD   40   {"sequence": 40, "ether-type": 34525, "dst-ip-mask": "FFFF:FFFF::0", "src-ip-list": "IPV6", "dst-ip": "2001:200::0"}  
	REST bigtap add policy match       admin-view  IPv6_ADD   50   {"sequence": 50, "ether-type": 34525, "src-ip-mask": "FFFF:FFFF::0", "dst-ip-list": "IPV6", "src-ip": "2001:200::0"} 	
 	sleep_now                   short
	Bigtap Verify policy        IPv6_ADD   1   1    S203      7
	REST delete policy          admin-view  IPv6_ADD  
	[Tags]   sanity   skipped


Test IPv4/IPv6 Address Group    
  	bigtap_clean_up             policy
 	bigtap_clean_up             address-group   
 	Config IPv4 Address Group	IPV4 
 	Config IPv6 Address Group   IPV6
	Config bigtap policy        IPv46     S203-50   S203-52
	sleep_now                   short
	REST bigtap add policy match       admin-view  IPv46   10   {"sequence": 10, "src-ip-list": "IPV4", "ether-type": 2048} 
	REST bigtap add policy match       admin-view  IPv46   20   {"sequence": 20, "dst-ip-list": "IPV4", "ether-type": 2048} 	
	REST bigtap add policy match       admin-view  IPv46   40   {"sequence": 40, "ether-type": 2048, "dst-ip-mask": "255.255.255.0", "src-ip-list": "IPV4", "dst-ip": "10.10.10.0"}  
	REST bigtap add policy match       admin-view  IPv46   50   {"sequence": 50, "ether-type": 2048, "src-ip-mask": "255.255.255.0", "dst-ip-list": "IPV4", "src-ip": "10.10.10.0"}  	
	REST bigtap add policy match       admin-view  IPv46   110   {"sequence": 110, "src-ip-list": "IPV6", "ether-type": 34525} 
	REST bigtap add policy match       admin-view  IPv46   120   {"sequence": 120, "dst-ip-list": "IPV6", "ether-type": 34525} 	
	REST bigtap add policy match       admin-view  IPv46   140   {"sequence": 140, "ether-type": 34525, "dst-ip-mask": "FFFF:FFFF::0", "src-ip-list": "IPV6", "dst-ip": "2001:200::0"}  
	REST bigtap add policy match       admin-view  IPv46   150   {"sequence": 150, "ether-type": 34525, "src-ip-mask": "FFFF:FFFF::0", "dst-ip-list": "IPV6", "src-ip": "2001:200::0"} 
		
	REST bigtap add policy match       admin-view  IPv46   200   {"sequence": 200, "src-ip-list": "IPV4","ether-type": 34525}  negative	
	REST bigtap add policy match       admin-view  IPv46   210   {"sequence": 210, "dst-ip-list": "IPV4","ether-type": 34525}  negative
	REST bigtap add policy match       admin-view  IPv46   220   {"sequence": 220, "src-ip-list": "IPV6","ether-type": 2048}  negative	
	REST bigtap add policy match       admin-view  IPv46   230   {"sequence": 230, "dst-ip-list": "IPV6","ether-type": 2048}  negative
	
	REST bigtap add policy match       admin-view  IPv46   300   {"sequence": 300, "dst-ip-list": "IPV6", "src-ip-list": "IPV4","ether-type": 2048}  negative		
	REST bigtap add policy match       admin-view  IPv46   310   {"sequence": 310, "dst-ip-list": "IPV6", "src-ip-list": "IPV4","ether-type": 34525}  negative	
	REST bigtap add policy match       admin-view  IPv46   320   {"sequence": 320, "dst-ip-list": "IPV4", "src-ip-list": "IPV6","ether-type": 2048}  negative		
	REST bigtap add policy match       admin-view  IPv46   330   {"sequence": 330, "dst-ip-list": "IPV4", "src-ip-list": "IPV6","ether-type": 34525}  negative	

	REST bigtap add policy match       admin-view  IPv46   400   {"sequence": 400, "ether-type": 34525, "dst-ip-mask": "255.255.255.0", "src-ip-list": "IPV6", "dst-ip": "200.200.200.0"}  negative
	REST bigtap add policy match       admin-view  IPv46   410   {"sequence": 410, "ether-type": 2048, "dst-ip-mask": "255.255.255.0", "src-ip-list": "IPV6", "dst-ip": "200.200.200.0"}  negative
	REST bigtap add policy match       admin-view  IPv46   420   {"sequence": 420, "ether-type": 34525, "src-ip-mask": "255.255.255.0", "dst-ip-list": "IPV6", "src-ip": "200.200.200.0"}  negative
	REST bigtap add policy match       admin-view  IPv46   430   {"sequence": 430, "ether-type": 2048, "src-ip-mask": "255.255.255.0", "dst-ip-list": "IPV6", "src-ip": "200.200.200.0"}  negative

	REST bigtap add policy match       admin-view  IPv46   500   {"sequence": 500, "ether-type": 34525, "dst-ip-mask": "FFFF:FFFF::0", "src-ip-list": "IPV4", "dst-ip": "2001:200::0"}  negative
	REST bigtap add policy match       admin-view  IPv46   510   {"sequence": 510, "ether-type": 2048, "dst-ip-mask": "FFFF:FFFF::0", "src-ip-list": "IPV4", "dst-ip": "2001:200::0"}  negative
	REST bigtap add policy match       admin-view  IPv46   520   {"sequence": 520, "ether-type": 34525, "src-ip-mask": "FFFF:FFFF::0", "dst-ip-list": "IPV4", "src-ip": "2001:200::0"}  negative
	REST bigtap add policy match       admin-view  IPv46   530   {"sequence": 530, "ether-type": 2048, "src-ip-mask": "FFFF:FFFF::0", "dst-ip-list": "IPV4", "src-ip": "2001:200::0"}  negative
		
 	sleep_now                   short
	Bigtap Verify policy        IPv46   1   1    S203      11
	REST delete policy          admin-view  IPv46  
	[Tags]   sanity   skipped


Test IP_overlap Address Group    
  	bigtap_clean_up             policy
 	bigtap_clean_up             address-group   
 	Config IPv4 Address Group	IPV4 
 	Config IPv6 Address Group   IPV6
	Config bigtap policy        IP1   S203-50   S204-52
	Config bigtap policy        IP2   S203-50   S203-52
	sleep_now                   short
	REST bigtap add policy match       admin-view  IP1   10   {"sequence": 10, "src-ip-list": "IPV4", "ether-type": 2048} 
	REST bigtap add policy match       admin-view  IP1   20   {"sequence": 20, "src-ip-list": "IPV6", "ether-type": 34525} 	
	REST bigtap add policy match       admin-view  IP2   10   {"sequence": 10, "dst-ip-list": "IPV4", "ether-type": 2048} 
	REST bigtap add policy match       admin-view  IP2   20   {"sequence": 20, "dst-ip-list": "IPV6", "ether-type": 34525} 		
		
 	sleep_now                   short
   	REST show bigtap policy       IP1     1   1
    REST show bigtap policy       IP2     1   1   	 	
	Bigtap Verify policy        _IP2_o_IP1   1   2    S203      9
#	REST delete policy          admin-view  IPv6_ADD  
	[Tags]   sanity   skipped

Test L3_L4_Mode    
	bigtap_clean_up             policy
 	sleep_now                   short  		
  	bigtap_clean_up             l3-l4-mode
 	sleep_now                   short  	
# verify default is l3-l4-mode disable
  	REST bigtap verify feature	    l3_l4=False  inport_mask=True
# config l3-l4-mode and verify
  	REST bigtap config l34    true
 	sleep_now                   short  	
  	REST bigtap verify feature	    l3_l4=True
  	
 # verify l3-l4-mode can not be disabled with policy	
  	Config bigtap policy        IP1   S203-50   S204-52
  	REST bigtap config l34    False   negative   	
  	
 # verify l3-l4-mode can not be enable with policy
  	bigtap_clean_up             policy
  	REST bigtap config l34      false
 	sleep_now                   short  	  	
  	REST bigtap verify feature	    l3_l4=False
  	Config bigtap policy        IP2   S203-50   S204-52
 	sleep_now                   short  	  	  	
  	REST bigtap config l34      true    negative   		 
  	 
#	REST delete policy          admin-view  IPv6_ADD  
	[Tags]   sanity  skipped



Test optimization 
# prepare
	bigtap_clean_all      
#	bigtap_clean_policy
#	bigtap_clean_addrgroup	     	    
 	sleep_now                   short   			
	Config bigtap policy        IP1   S203-50   S204-52
	sleep_now                   3
#   Test prefix optimization
#	bigtap_gen_config_match_new   IP1   ip  src_ip  10.0.0.0  0.0.0.1  255.255.255.255  10  100  
	bigtap_gen_config_match_new   IP1   ipv6  src_ip  f001:100:0:0:0:0:0:fffe 	0:1:0:0:0:0:0:1	  ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff  20  150 
#	bigtap_gen_config_match_new   IP1   tcp  dst_port  100  1   number=10  sequence=200 
#	bigtap_gen_config_match_new   IP1   tcp6  dst_port  200  1   number=10  sequence=300 	
#	bigtap_gen_config_match_new   IP1   tcp6  vlan  200  1   number=10  sequence=300 		
#	bigtap_gen_config_match_new   IP1   ip  vlan  500  1   number=10  sequence=500 	
	bigtap_gen_config_match_new   IP1   ip  src_mac  5c:16:c7:13:fc:fe   0:0:0:0:0:1   number=3  sequence=500 	


# verify tcp port optimize	for ipv4 and ipv6
#	REST bigtap add policy match       admin-view  IP1   10   {"dst-tp-port-min": 16, "ether-type": 2048, "dst-tp-port-max": 31, "ip-proto": 6, "sequence": 10} 	
#	REST bigtap show policy optimize	IP1	   1 
#	REST bigtap add policy match       admin-view  IP1   10   {"dst-tp-port-min": 16, "ether-type": 34525, "dst-tp-port-max": 31, "ip-proto": 6, "sequence": 10} 		 
#	REST bigtap show policy optimize	IP1	   1 


		 	
	[Tags]   sanity   


Load and apply config file
#	remote_copy    blackbird.txt
#	bigtap_gen_address_group	 IPV4 	 ipv4_10	ipv4 	10.0.0.0 	0.1.0.1		255.255.255.255 	10
#	bigtap_gen_address_group	 IPV6 	 ipv6_10	ipv6 	f001:100:0:0:0:0:0:0 	0:0:0:0:0:0:0:1		ffff:ffff:ffff:ffff:ffff:fff:ffff:ffff 	20
#	bigtap_gen_match	 		 IPV4 	 pIpv4	    ip  	src-ip	 10.0.0.0 	0.0.0.1	 255.255.255.255 	10   dst-ip 100.100.100.100 255.255.255.255
#	bigtap_gen_match	 		 IPV6 	 pIpv6	    ip6  	src-ip	 f001:100:0:0:0:0:0:0 	0:1:0:0:0:0:0:1	  ffff:ffff:ffff:ffff:ffff:fff:ffff:ffff 	20
#	copy_to_controller           IPV4     /opt/bigswitch/run/saved-configs/IPV4
#	REST copy_file_to_running    IPV4 
#	bigtap_gen_config_addrgroup  	 IPV4    ipv4 	10.0.0.0 	0.1.0.1		255.255.255.0 	20
#	bigtap_gen_config_addrgroup 	 IPV6    ipv6 	f001:100:0:0:0:0:0:0 	0:0:0:0:0:0:0:1		ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff 	20

   	REST bigtap_create_policy  admin-view    IPV46
	bigtap_gen_config_match           IPV46    ip     src_ip    10.0.0.0     0.0.1.0   255.255.255.0  3   100   dst_ip=100.100.100.1  dst_ip_mask=255.255.255.0

	bigtap_gen_config_match           IPV46    ipv6     src_ip    f001:100:0:0:0:0:0:0   0:0:0:0:0:0:0:1		ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff   3   1000

#	bigtap_construct_match       ip      tcp      16     33 
#	bigtap_construct_match       kwarg {"ip":"ip","src_ip":"10.0.0.0","src_ip_mask":"255.255.255.0"}	 
	[Tags]  sanity  skipped


* Keywords
Config bigtap policy
	[Arguments]          			    	  ${pName}  ${intFname}  ${intDname}
	REST bigtap create policy 	  admin-view  ${pName}  forward 
	REST bigtap add policy interface   admin-view  ${pName}  ${intFname}  filter 
	REST bigtap add policy interface  admin-view  ${pName}  ${intDname}  delivery 
 	
	
show command  
	REST show version  
	REST show user 
	REST show controller  
	REST show bigtap  

Config IPv4 Address Group           [Arguments]  ${GName}
	REST bigtap create addrgroup      ${GName}   ipv4  
	REST bigtap add addrgroup          ${GName}   100.100.100.100   255.255.255.255  
	REST bigtap verify addrgroup   ${GName}   ipv4   
	REST bigtap add addrgroup          ${GName}   2001:100::0   FFFF:FFFF::0   negative

Config IPv6 Address Group           [Arguments]  ${GName}
	REST bigtap create addrgroup      ${GName}    ipv6  
	REST bigtap add addrgroup         ${GName}    2001:100::0   FFFF:FFFF::0   
	REST bigtap verify addrgroup   ${GName}6    ipv6  
	REST bigtap add addrgroup         ${GName}   100.100.100.100   255.255.255.255   negative

Bigtap Setup role 
 
	REST bigtap setup role    S204    ethernet49    filter     S204-49 
	REST bigtap setup role    S204    ethernet42    delivery   S204-42 
	REST bigtap setup role    S204    ethernet43    service    S204-43 
	REST bigtap setup role    S204    ethernet44    service    S204-44 
	
Bigtap Verify policy
	[Arguments]                   ${pName}     ${numFIntf}   ${numDIntf}   ${swName}    ${numFlow} 
	REST bigtap show run policy   ${pName}
   	REST show bigtap policy       ${pName}     ${numFIntf}   ${numDIntf}
	REST verify switch flow          ${swName}    ${numFlow} 