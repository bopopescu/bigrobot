== T5 Functional CLI Test Suite ==

* Setting
Documentation    T5 BVS APP Functional VNS forwarding Test Suite for Tag
Suite Setup      base suite setup
Suite Teardown   base suite teardown
Test Setup       base test setup
Test Teardown    base test teardown
Force Tags       T5 
Library          keywords/BsnCommon.py
Library          keywords_dev/T5.py
Library	         keywords_dev/T5Fabric.py
Library          keywords/Mininet.py
Resource	     keywords_dev/t5_dualleaf_three_rack_resource.txt

* Variables
${bm0_ip}  10.0.0.1
${bm1_ip}  10.0.0.2
${bm2_ip}  10.0.0.3
${bm3_ip}  10.0.0.4
${bm4_ip}  10.0.0.5
${bm5_ip}  10.0.0.6
${bm0_mac}  00:00:00:00:00:01
${bm1_mac}  00:00:00:00:00:02
${bm2_mac}  00:00:00:00:00:03
${bm3_mac}  00:00:00:00:00:04
${bm4_mac}  00:00:00:00:00:05
${bm5_mac}  00:00:00:00:00:06
${bm0_intf0}  leaf0a-eth8
${bm0_intf1}  leaf0b-eth8
${bm1_intf0}  leaf0a-eth9
${bm1_intf1}  leaf0b-eth9
${bm2_intf0}  leaf1a-eth8
${bm2_intf1}  leaf1b-eth8
${bm3_intf0}  leaf1a-eth9
${bm3_intf1}  leaf1b-eth9
${bm4_intf0}  leaf2a-eth8
${bm4_intf1}  leaf2b-eth8
${bm5_intf0}  leaf2a-eth9
${bm5_intf1}  leaf2b-eth9

* Test Case 

Configure Dual Leaf Three Rack setup
   [Tags]  functional
   sleep  5
   configure fabric switch
   sleep  5
   rest check fabric switch connectivity
   rest verify fabric link

Configure Multiple VNS and membership rules
   [Tags]   functional
   create a tenant  t1
   create a vns  t1  v1
   create a vns  t1  v2
   create a vns  t1  v3
   create a portgroup  p1 
   add interface to portgroup  leaf0-a  ${bm0_intf0}  p1
   add interface to portgroup  leaf0-b  ${bm0_intf1}  p1
   create a portgroup  p2 
   add interface to portgroup  leaf0-a  ${bm1_intf0}  p2
   add interface to portgroup  leaf0-b  ${bm1_intf1}  p2
   create a portgroup  p3 
   add interface to portgroup  leaf1-a  ${bm2_intf0}  p3
   add interface to portgroup  leaf1-b  ${bm2_intf1}  p3
   create a portgroup  p4 
   add interface to portgroup  leaf1-a  ${bm3_intf0}  p4
   add interface to portgroup  leaf1-b  ${bm3_intf1}  p4
   create a portgroup  p5 
   add interface to portgroup  leaf2-a  ${bm4_intf0}  p5
   add interface to portgroup  leaf2-b  ${bm4_intf1}  p5
   create a portgroup  p6 
   add interface to portgroup  leaf2-a  ${bm5_intf0}  p6
   add interface to portgroup  leaf2-b  ${bm5_intf1}  p6
   rest add portgroup to vns  t1  v1  p1  100
   rest add portgroup to vns  t1  v1  p6  150
   rest add portgroup to vns  t1  v2  p2  500 
   rest add portgroup to vns  t1  v2  p4  500
   rest add portgroup to vns  t1  v3  p3  1500 
   rest add portgroup to vns  t1  v3  p5  1500
   rest show tenant
   rest show vns 
 
Check forwarding between rack0-bm0 and rack2-bm5 different tags 
   [Tags]  functional
   mininet link tag  bm0  bm0-bond0  100  ${bm0_ip}
   mininet link tag  bm5  bm5-bond0  150  ${bm5_ip}
   sleep  5
   ${loss}=  mininet ping  bm0  ${bm5_ip}
   Should Be True  ${loss} == 0
   rest verify endpoint portgroup  v1  100  ${bm0_ip}  p1
   rest verify endpoint portgroup  v1  150  ${bm5_ip}  p6
   
Check forwarding between rack0-bm1 and rack1-bm3
   [Tags]  functional
   mininet link tag  bm1  bm1-bond0  500  ${bm1_ip}
   mininet link tag  bm3  bm3-bond0  500  ${bm3_ip}
   sleep  5
   ${loss}=  mininet ping  bm1  ${bm3_ip}
   Should Be True  ${loss} == 0

Check forwarding between rack1-bm2 to rack2-bm4
   [Tags]  functional
   mininet link tag  bm2  bm2-bond0  1500  ${bm2_ip}
   mininet link tag  bm4  bm4-bond0  1500  ${bm4_ip}
   ${loss}=  mininet ping  bm2  ${bm4_ip}
   Should Be True  ${loss} == 0

Check forwarding between rack0-bm0 and rack2-bm5 after deleting bm5 member-interface
   [Tags]  functional
   rest delete portgroup from vns  t1  v1  p6  150
   sleep  5
   ${loss}=  mininet ping  bm0  ${bm5_ip}
   Should Be True  ${loss} == 100
   
Check forwarding between rack0-bm0 and rack2-bm5 after adding back member interface 
   [Tags]  functional
   rest add portgroup to vns  t1  v1  p6  150
   sleep  5
   ${loss}=  mininet ping  bm0  ${bm5_ip}
   Should Be True  ${loss} <= 20
   
Check forwarding with multiple tags on same interface different vns
   [Tags]  functional
   create a vns  t1  v4
   rest add portgroup to vns  t1  v4  p1  200
   rest add portgroup to vns  t1  v4  p6  250
   mininet link untag  bm0  bm0-bond0  100  ${bm0_ip}
   mininet link untag  bm5  bm5-bond0  150  ${bm5_ip}
   mininet link tag  bm0  bm0-bond0  200  ${bm0_ip}
   mininet link tag  bm5  bm5-bond0  250  ${bm5_ip}
   sleep  5
   ${loss}=  mininet ping  bm0  ${bm5_ip}
   Should Be True  ${loss} == 0
   rest verify endpoint portgroup  v1  200  ${bm0_ip}  p1
   rest verify endpoint portgroup  v1  250  ${bm5_ip}  p6

Check forwarding between rack1-bm2 and rack2-bm4 after deleting VNS
   [Tags]  functional
   delete a vns  t1  v3
   sleep  5
   ${loss}=  mininet ping  bm2  ${bm4_ip}
   Should Be True  ${loss} == 100
   
Check forwarding between rack1-bm2 and rack2-bm4 after adding VNS
   [Tags]  functional
   create a vns  t1  v3
   rest add portgroup to vns  t1  v3  p3  1500 
   rest add portgroup to vns  t1  v3  p5  1500
   sleep  10
   ${loss}=  mininet ping  bm2  ${bm4_ip}
   Should Be True  ${loss} <= 20
   
Check forwarding between rack0-bm0 and rack2-bm5 after deleting tenant
   [Tags]  functional
   delete a tenant  t1
   sleep  5
   ${loss}=  mininet ping  bm0  ${bm5_ip}
   Should Be True  ${loss} == 100
   ${loss}=  mininet ping  bm2  ${bm4_ip}
   Should Be True  ${loss} == 100
   ${loss}=  mininet ping  bm1  ${bm3_ip}
   Should Be True  ${loss} == 100 

Tear down the config
   [Tags]  smoke  sanity 
   delete a tenant  t1
   delete interface from portgroup  leaf0-a  ${bm0_intf0}  p1
   delete interface from portgroup  leaf0-b  ${bm0_intf1}  p1
   delete interface from portgroup  leaf0-a  ${bm1_intf0}  p2
   delete interface from portgroup  leaf0-b  ${bm1_intf1}  p2
   delete interface from portgroup  leaf1-a  ${bm2_intf0}  p3 
   delete interface from portgroup  leaf1-b  ${bm2_intf1}  p3 
   delete interface from portgroup  leaf1-a  ${bm3_intf0}  p4 
   delete interface from portgroup  leaf1-b  ${bm3_intf1}  p4
   delete interface from portgroup  leaf2-a  ${bm4_intf0}  p5 
   delete interface from portgroup  leaf2-b  ${bm4_intf1}  p5
   delete interface from portgroup  leaf2-a  ${bm5_intf0}  p6 
   delete interface from portgroup  leaf2-b  ${bm5_intf1}  p6 
   delete a portgroup  p1
   delete a portgroup  p2
   delete a portgroup  p3
   delete a portgroup  p4
   delete a portgroup  p5
   delete a portgroup  p6
   remove fabric switch

* Keywords      
   
create a tenant  [Arguments]  ${tenant} 
  REST create tenant  ${tenant}    

delete a tenant  [Arguments]  ${tenant} 
  	REST delete tenant  ${tenant}    

create a vns  [Arguments]  ${tenant}  ${vns}  
	REST create vns  ${tenant}  ${vns}   

delete a vns  [Arguments]  ${tenant}  ${vns} 
  	REST delete vns  ${tenant}  ${vns}   

create a portgroup  [Arguments]  ${pg}
  	REST create portgroup  ${pg}    

delete a portgroup  [Arguments]  ${pg}
  	REST delete portgroup  ${pg}    

create a endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint} 
  	REST create endpoint  ${tenant}  ${vns}  ${endpoint}  

delete a endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint}
  	REST delete endpoint  ${tenant}  ${vns}  ${endpoint}  

add interface to portgroup  [Arguments]  ${switch}  ${intf}  ${pg} 
  	REST add interface to portgroup  ${switch}  ${intf}  ${pg}  

delete interface from portgroup  [Arguments]  ${switch}  ${intf}  ${pg} 
  	REST delete interface from portgroup  ${switch}  ${intf}  ${pg}  

add portgroup to vns  [Arguments]  ${tenant}  ${vns}  ${pg}  ${vlan}
  	REST add portgroup to vns  ${tenant}  ${vns}  ${pg}  ${vlan} 

add portgroup to endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint}  ${pg}  ${vlan} 
    REST add portgroup to endpoint  ${tenant}  ${vns}  ${endpoint}  ${pg}  ${vlan} 

delete portgroup from vns  [Arguments]  ${tenant}  ${vns}  ${pg}  ${vlan} 
    REST delete portgroup from vns  ${tenant}  ${vns}  ${pg}  ${vlan}
  


 
