== T5 Functional CLI Test Suite ==

* Setting
Documentation    T5 BVS APP Functional VNS forwarding Test Suite for Tag
Suite Setup      base suite setup
Suite Teardown   base suite teardown
Test Setup       base test setup
Test Teardown    base test teardown
Force Tags       T5 
Library          keywords/BsnCommon.py
Library          keywords_dev/T5.py
Library	         keywords_dev/T5Fabric.py
Library          keywords/Mininet.py
Resource	     keywords_dev/t5_dualleaf_three_rack_resource.txt

* Variables
${h1_ip}  10.0.0.1
${h2_ip}  10.0.0.2
${h3_ip}  10.0.0.3
${h4_ip}  10.0.0.4
${h5_ip}  10.0.0.5
${h6_ip}  10.0.0.6
${h1_mac}  00:00:00:00:00:01
${h2_mac}  00:00:00:00:00:02
${h3_mac}  00:00:00:00:00:03
${h4_mac}  00:00:00:00:00:04
${h5_mac}  00:00:00:00:00:05
${h6_mac}  00:00:00:00:00:06
${h1_intf0}  leaf0a-eth8
${h1_intf1}  leaf0b-eth8
${h2_intf0}  leaf0a-eth9
${h2_intf1}  leaf0b-eth9
${h3_intf0}  leaf1a-eth8
${h3_intf1}  leaf1b-eth8
${h4_intf0}  leaf1a-eth9
${h4_intf1}  leaf1b-eth9
${h5_intf0}  leaf2a-eth8
${h5_intf1}  leaf2b-eth8
${h6_intf0}  leaf2a-eth9
${h6_intf1}  leaf2b-eth9

* Test Case 

add Dual Leaf Three Rack setup
   [Tags]  functional
   sleep  5
   add fabric switch
   sleep  5
   rest check fabric switch connectivity
   rest verify fabric link

add Multiple VNS and membership rules
   [Tags]   functional
   add a tenant  t1
   add a vns  t1  v1
   add a vns  t1  v2
   add a vns  t1  v3
   add a portgroup  p1 
   add interface to portgroup  leaf0-a  ${h1_intf0}  p1
   add interface to portgroup  leaf0-b  ${h1_intf1}  p1
   add a portgroup  p2 
   add interface to portgroup  leaf0-a  ${h2_intf0}  p2
   add interface to portgroup  leaf0-b  ${h2_intf1}  p2
   add a portgroup  p3 
   add interface to portgroup  leaf1-a  ${h3_intf0}  p3
   add interface to portgroup  leaf1-b  ${h3_intf1}  p3
   add a portgroup  p4 
   add interface to portgroup  leaf1-a  ${h4_intf0}  p4
   add interface to portgroup  leaf1-b  ${h4_intf1}  p4
   add a portgroup  p5 
   add interface to portgroup  leaf2-a  ${h5_intf0}  p5
   add interface to portgroup  leaf2-b  ${h5_intf1}  p5
   add a portgroup  p6 
   add interface to portgroup  leaf2-a  ${h6_intf0}  p6
   add interface to portgroup  leaf2-b  ${h6_intf1}  p6
   rest add portgroup to vns  t1  v1  p1  100
   rest add portgroup to vns  t1  v1  p6  150
   rest add portgroup to vns  t1  v2  p2  500 
   rest add portgroup to vns  t1  v2  p4  500
   rest add portgroup to vns  t1  v3  p3  1500 
   rest add portgroup to vns  t1  v3  p5  1500
   rest show tenant
   rest show vns 
 
Check forwarding between rack0-h1 and rack2-h6 different tags 
   [Tags]  functional
   mininet link tag  h1  h1-bond0  100  ${h1_ip}
   mininet link tag  h6  h6-bond0  150  ${h6_ip}
   sleep  5
   ${loss}=  mininet ping  h1  ${h6_ip}
   Should Be True  ${loss} == 0
   rest verify endpoint portgroup  v1  100  ${h1_ip}  p1
   rest verify endpoint portgroup  v1  150  ${h6_ip}  p6
   
Check forwarding between rack0-h2 and rack1-h4
   [Tags]  functional
   mininet link tag  h2  h2-bond0  500  ${h2_ip}
   mininet link tag  h4  h4-bond0  500  ${h4_ip}
   sleep  5
   ${loss}=  mininet ping  h2  ${h4_ip}
   Should Be True  ${loss} == 0

Check forwarding between rack1-h3 to rack2-h5
   [Tags]  functional
   mininet link tag  h3  h3-bond0  1500  ${h3_ip}
   mininet link tag  h5  h5-bond0  1500  ${h5_ip}
   ${loss}=  mininet ping  h3  ${h5_ip}
   Should Be True  ${loss} == 0

Check forwarding between rack0-h1 and rack2-h6 after deleting h6 member-interface
   [Tags]  functional
   rest delete portgroup from vns  t1  v1  p6  150
   sleep  5
   ${loss}=  mininet ping  h1  ${h6_ip}
   Should Be True  ${loss} == 100
   
Check forwarding between rack0-h1 and rack2-h6 after adding back member interface 
   [Tags]  functional
   rest add portgroup to vns  t1  v1  p6  150
   sleep  5
   ${loss}=  mininet ping  h1  ${h6_ip}
   Should Be True  ${loss} <= 20
   
Check forwarding with multiple tags on same interface different vns
   [Tags]  functional
   add a vns  t1  v4
   rest add portgroup to vns  t1  v4  p1  200
   rest add portgroup to vns  t1  v4  p6  250
   mininet link untag  h1  h1-bond0  100  ${h1_ip}
   mininet link untag  h6  h6-bond0  150  ${h6_ip}
   mininet link tag  h1  h1-bond0  200  ${h1_ip}
   mininet link tag  h6  h6-bond0  250  ${h6_ip}
   sleep  5
   ${loss}=  mininet ping  h1  ${h6_ip}
   Should Be True  ${loss} == 0
   rest verify endpoint portgroup  v1  200  ${h1_ip}  p1
   rest verify endpoint portgroup  v1  250  ${h6_ip}  p6

Check forwarding between rack1-h3 and rack2-h5 after deleting VNS
   [Tags]  functional
   delete a vns  t1  v3
   sleep  5
   ${loss}=  mininet ping  h3  ${h5_ip}
   Should Be True  ${loss} == 100
   
Check forwarding between rack1-h3 and rack2-h5 after adding VNS
   [Tags]  functional
   add a vns  t1  v3
   rest add portgroup to vns  t1  v3  p3  1500 
   rest add portgroup to vns  t1  v3  p5  1500
   sleep  10
   ${loss}=  mininet ping  h3  ${h5_ip}
   Should Be True  ${loss} <= 20
   
Check forwarding between rack0-h1 and rack2-h6 after deleting tenant
   [Tags]  functional
   delete a tenant  t1
   sleep  5
   ${loss}=  mininet ping  h1  ${h6_ip}
   Should Be True  ${loss} == 100
   ${loss}=  mininet ping  h3  ${h5_ip}
   Should Be True  ${loss} == 100
   ${loss}=  mininet ping  h2  ${h4_ip}
   Should Be True  ${loss} == 100 

Tear down the config
   [Tags]  smoke  sanity 
   delete a tenant  t1
   delete interface from portgroup  leaf0-a  ${h1_intf0}  p1
   delete interface from portgroup  leaf0-b  ${h1_intf1}  p1
   delete interface from portgroup  leaf0-a  ${h2_intf0}  p2
   delete interface from portgroup  leaf0-b  ${h2_intf1}  p2
   delete interface from portgroup  leaf1-a  ${h3_intf0}  p3 
   delete interface from portgroup  leaf1-b  ${h3_intf1}  p3 
   delete interface from portgroup  leaf1-a  ${h4_intf0}  p4 
   delete interface from portgroup  leaf1-b  ${h4_intf1}  p4
   delete interface from portgroup  leaf2-a  ${h5_intf0}  p5 
   delete interface from portgroup  leaf2-b  ${h5_intf1}  p5
   delete interface from portgroup  leaf2-a  ${h6_intf0}  p6 
   delete interface from portgroup  leaf2-b  ${h6_intf1}  p6 
   delete a portgroup  p1
   delete a portgroup  p2
   delete a portgroup  p3
   delete a portgroup  p4
   delete a portgroup  p5
   delete a portgroup  p6
   delete fabric switch

* Keywords      
   
add a tenant  [Arguments]  ${tenant} 
  REST add tenant  ${tenant}    

delete a tenant  [Arguments]  ${tenant} 
  	REST delete tenant  ${tenant}    

add a vns  [Arguments]  ${tenant}  ${vns}  
	REST add vns  ${tenant}  ${vns}   

delete a vns  [Arguments]  ${tenant}  ${vns} 
  	REST delete vns  ${tenant}  ${vns}   

add a portgroup  [Arguments]  ${pg}
  	REST add portgroup  ${pg}    

delete a portgroup  [Arguments]  ${pg}
  	REST delete portgroup  ${pg}    

add a endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint} 
  	REST add endpoint  ${tenant}  ${vns}  ${endpoint}  

delete a endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint}
  	REST delete endpoint  ${tenant}  ${vns}  ${endpoint}  

add interface to portgroup  [Arguments]  ${switch}  ${intf}  ${pg} 
  	REST add interface to portgroup  ${switch}  ${intf}  ${pg}  

delete interface from portgroup  [Arguments]  ${switch}  ${intf}  ${pg} 
  	REST delete interface from portgroup  ${switch}  ${intf}  ${pg}  

add portgroup to vns  [Arguments]  ${tenant}  ${vns}  ${pg}  ${vlan}
  	REST add portgroup to vns  ${tenant}  ${vns}  ${pg}  ${vlan} 

add portgroup to endpoint  [Arguments]  ${tenant}  ${vns}  ${endpoint}  ${pg}  ${vlan} 
    REST add portgroup to endpoint  ${tenant}  ${vns}  ${endpoint}  ${pg}  ${vlan} 

delete portgroup from vns  [Arguments]  ${tenant}  ${vns}  ${pg}  ${vlan} 
    REST delete portgroup from vns  ${tenant}  ${vns}  ${pg}  ${vlan}
  


 
