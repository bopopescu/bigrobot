== T5 Fabric Traffic Failover Test ==

*Settings
Documentation    Fabric Failover Test using Three Rack Dual Spine
Suite Setup      base suite setup
Suite Teardown   base suite teardown
Test Setup       base test setup
Test Teardown    T5 test teardown
Force Tags       T5 
Library          keywords/BsnCommon.py
Library          keywords/T5.py
Library          keywords/T5Platform.py
Library			 keywords/SwitchLight.py
Library			 keywords/Ixia.py
Library			 keywords/Host.py
Resource         testsuites/T5/t5_dualleaf_three_rack_physical_resource.txt
Resource         testsuites/T5/t5_physical_variables.txt

*Test Case

Setup Three Rack Dual Leaf Topology
	base suite setup  
    add fabric switch
    bring up h1 bond0
    bring up h2 bond0
    bring up h3 bond0
    bring up h4 bond0
    bring up h5 bond0
    bring up h6 bond0
    sleep  5
    rest verify fabric switch all
	rest verify fabric link 	

With 2k mac entries , Remove the Leaf switch and Readd the leaf switch
    [Tags]  feature  
    rest add tenant  t1
    rest add vns  t1  v1
    rest add interface to vns  t1  v1  leaf0-a  ${leaf0a_ixia_intf}  -1
    rest add interface to vns  t1  v1  leaf2-a  ${leaf2a_ixia_intf}  -1
    ${stream}=             L3 add  no_arp=True  flow=a<->e  src_mac=00:00:01:00:00:01  dst_mac=00:00:02:00:00:01  src_cnt=1000  dst_cnt=1000  dst_mac_step=00:00:00:00:00:01  src_mac_step=00:00:00:00:00:01  frame_rate=1000  frame_size=68  name=a_e_flow
    start traffic  ${stream}
    rest verify endpoint in system  2000
    verify traffic rate  tx_rate  rx_rate  a  e
    verify traffic rate  tx_rate  rx_rate  e  a
    rest verify fabric link common
    rest delete fabric switch  leaf0-a
    rest verify endpoint in system  1000
    rest add switch  leaf0-a
    rest add dpid  leaf0-a  ${leaf0a_dpid}
    rest add fabric role  leaf0-a  leaf
    rest add leaf group  leaf0-a  rack0
    sleep  3
    rest verify fabric switch role  ${leaf0a_dpid}  leaf
    rest verify fabric link common
    rest verify forwarding vlan fabric tag members  leaf0-a
    sleep  15
    verify traffic rate  tx_rate  rx_rate  a  e
    verify traffic rate  tx_rate  rx_rate  e  a
    rest verify endpoint in system  2000
    stop traffic  ${stream}
    rest delete tenant  t1               
     
shutdown the switch and check the links are down in the switch
	[Tags]  feature  Manual  untested
	rest add tenant  t1
	rest add vns  t1  v1
	rest add portgroup  p4 
    rest add interface to portgroup  leaf1-a  ${h4_intf0}  p4
    rest add interface to portgroup  leaf1-b  ${h4_intf1}  p4
    rest add portgroup lacp  p4  
    rest add portgroup  p5 
    rest add interface to portgroup  leaf2-a  ${h5_intf0}  p5
    rest add interface to portgroup  leaf2-b  ${h5_intf1}  p5
    rest add portgroup lacp  p5
    rest add portgroup to vns  t1  v1  p4  -1
    rest add portgroup to vns  t1  v1  p5  -1
    sleep  3
    rest verify fabric link common
    rest verify fabric interface lacp  leaf1-a  ${h4_intf0}
    rest verify fabric interface lacp  leaf2-a  ${h5_intf0}  
    ${loss}=  bash ping  h5  ${h4_ip}  source_if=bond0
    Should Be True  ${loss} == 0
    rest add shutdown fabric switch  leaf2-a   
    sleep  2
    ${result}=  rest verify fabric link common
    Should not be True  ${result}
    rest verify fabric interface  leaf2-a  ${h5_intf0}  
    ${loss}=  bash ping  h5  ${h4_ip}  source_if=bond0
    Should Be True  ${loss} == 0
    rest delete shutdown fabric switch  leaf2-a
    sleep  3
    rest verify fabric interface  leaf2-a  ${h5_intf0} 
    rest verify fabric link common 
    ${loss}=  bash ping  h5  ${h4_ip}  source_if=bond0
    Should Be True  ${loss} == 0
    rest delete interface from portgroup  leaf1-a  ${h4_intf0}  p4
    rest delete interface from portgroup  leaf1-b  ${h4_intf1}  p4
    rest delete interface from portgroup  leaf2-a  ${h5_intf0}  p5
    rest delete interface from portgroup  leaf2-b  ${h5_intf1}  p5
    rest delete portgroup  p4
    rest delete portgroup  p5
    rest delete tenant  t1 
     
verify interface cli 
	[Tags]  feature
	${result}=  cli  c1   show interface  
	Should Not be Empty  ${result}
	${result}=  cli  c1  show interface ${leaf0a_spine0_intf0}
	Should Not be Empty  ${result}
		
verify lag cli
	[Tags]  feature
	${result}=  cli  c1  show lag  
	Should Not be Empty  ${result}
    ${result}=  cli  c1   show lag switch leaf0-a  
	Should Not be Empty  ${result}	

verify switch cli
	[Tags]  feature
	${result}=  cli  c1  show switch  
	Should Not be Empty  ${result}
	${result}=  cli  c1  show switch leaf0-a
	Should Not be Empty  ${result}
	${result}=  cli  c1  show switch leaf0-a interface ${leaf0a_spine0_intf0} 
	Should Not be Empty  ${result}
	
verify lacp cli
	[Tags]  feature
	rest add tenant  t1
	rest add vns  t1  v1
	rest add portgroup  p4 
    rest add interface to portgroup  leaf1-a  ${h4_intf0}  p4
    rest add interface to portgroup  leaf1-b  ${h4_intf1}  p4
    rest add portgroup lacp  p4  
    sleep  3
	${result}=  cli  c1  show lacp  
	Should Not be Empty  ${result}
	${result}=  cli  c1  show lacp switch leaf0-a
	Should Not be Empty  ${result}
	${result}=  cli  c1  show lacp switch leaf0-a interface ${h4_intf0} 
	Should Not be Empty  ${result}
	
verify link cli
	[Tags]  feature
	${result}=  cli  c1  show link  
	Should Not be Empty  ${result}

verify lag any_leaf cli
	[Tags]  feature
	${result}=  cli  c1  show lag switch spine0 any_leaf 
	Should Not be Empty  ${result}
	
Test forwarding entry when the switch falls below 50% spine links
	[Tags]  feature  Manual  untested
	verify fabric link
	rest delete fabric switch

reboot both the controllers to make sure all the switches indeed connected
	[Tags]  bugs  
	rest verify fabric link common
	cli verify cluster master reboot
	sleep  10
	rest verify fabric link common
	cli verify cluster master reboot
	sleep  10
	rest verify fabric link common
	
Tear down config and Topology
    delete fabric switch  
    rest delete portgroup  p4
    rest delete portgroup  p6
    rest delete tenant  t1
    rest delete tenant  t2
    base suite teardown
 

* Keywords  
	
verify traffic rate   [Arguments]  ${tx_rate}  ${rx_rate}  ${tx_intf}  ${rx_intf}
    Sleep  5
    ${report}=  fetch port stats
    Log  ${report}
    ${tx_value}=  verify dict key  ${report}  ${tx_intf}  transmitted_frame_rate
    ${rx_value}=  verify dict key  ${report}  ${rx_intf}  received_valid_frame_rate
    ixia verify traffic rate  ${tx_value}  ${rx_value}
    
verify traffic rate negative   [Arguments]  ${tx_rate}  ${rx_rate}  ${tx_intf}  ${rx_intf}
    Sleep  5
    ${report}=  fetch port stats
    ${tx_value}=  verify dict key  ${report}  ${tx_intf}  transmitted_frame_rate
    ${rx_value}=  verify dict key  ${report}  ${rx_intf}  received_valid_frame_rate
    Should Not be equal  ${tx_value}  ${rx_value}
    
T5 test teardown
	delete traffic

bring up h1 bond0
	bash init intf  h1  bond0.10
    bash add ip address  h1  ${h1_tag_ip}/24  bond0.10
    bash ifup intf  h1  bond0 
bring up h2 bond0
	bash init intf  h2  bond0.10
    bash add ip address  h2  ${h2_tag_ip}/24  bond0.10
    bash ifup intf  h2  bond0
bring up h3 bond0
	bash init intf  h3  bond0.10
    bash add ip address  h3  ${h3_tag_ip}/24  bond0.10
    bash ifup intf  h3  bond0 
bring up h4 bond0
	bash init intf  h4  bond0
    bash add ip address  h4  ${h4_ip}/24  bond0
    bash ifup intf  h4  bond0
bring up h5 bond0
	bash init intf  h5  bond0
    bash add ip address  h5  ${h5_ip}/24  bond0
    bash ifup intf  h5  bond0
bring up h6 bond0
	bash init intf  h6  bond0
    bash add ip address  h6  ${h6_ip}/24  bond0
    bash ifup intf  h6  bond0  
